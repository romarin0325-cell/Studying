
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Turn RPG: Legend Edition v9.3 (Fix Update)</title>
<style>
    /* =========================================
       Global Layout
       ========================================= */
    body { 
        background-color: #121212; 
        color: #e0e0e0; 
        font-family: 'Suit', sans-serif; 
        margin: 0; padding: 0; 
        display: flex; flex-direction: column; 
        height: 100vh; height: 100dvh; 
        overflow: hidden; 
        user-select: none; 
    }

    .header { padding: 10px; text-align: center; background: #1f1f1f; border-bottom: 1px solid #333; font-size: 0.95rem; color: #bbb; font-weight: bold; flex-shrink: 0; }
    
    .container { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        padding: 8px; 
        overflow: hidden; 
        gap: 8px;
    }

    /* ìƒë‹¨ ìƒíƒœì°½ */
    .status-panel { 
        background: #222; padding: 8px 12px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .status-top { display: flex; justify-content: space-between; align-items: center; }
    .char-info { font-size: 1.0rem; font-weight: bold; color: #fff; }
    .stat-bars { width: 55%; }
    .bar-box { background: #444; height: 14px; border-radius: 8px; margin: 3px 0; position: relative; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.3s ease; }
    .hp-bar { background: #d32f2f; }
    .mp-bar { background: #1976d2; }
    .bar-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 10px; line-height: 14px; color: #fff; text-shadow: 1px 1px 1px #000; }
    .stat-detail { font-size: 0.7rem; color: #bbb; display: flex; justify-content: space-between; background: #2a2a2a; padding: 5px; border-radius: 4px; }
    .artifact-box { font-size: 0.7rem; color: #ffd700; white-space: nowrap; overflow-x: auto; padding: 4px; background: #2a2a2a; border-radius: 4px; border: 1px dashed #555; }

    /* =========================================
       ë¹„ì£¼ì–¼ ìŠ¤í…Œì´ì§€
       ========================================= */
    .visual-stage {
        flex: 0 0 auto; 
        position: relative;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 6px;
        min-height: 150px; 
        background-image: linear-gradient(to bottom, #2a2a2a, #121212);
    }

    .actor-box {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        transition: all 0.3s ease;
    }
    .actor-box.player { left: 15px; }
    .actor-box.enemy { right: 15px; opacity: 0; }

    .portrait {
        width: 54px; height: 72px; /* 3:4 ë¹„ìœ¨ */
        border-radius: 8px;
        background: #000;
        border: 2px solid #555;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.7);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.8rem;
    }
    .portrait img { width: 100%; height: 100%; object-fit: cover; }

    .mini-stat {
        position: absolute;
        width: 140px; 
        background: rgba(30, 30, 30, 0.85);
        padding: 6px 10px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #444;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        z-index: 5;
        transition: all 0.3s ease;
    }

    .player-stat { top: 15px; left: 42%; transform: translateX(-50%); }
    .enemy-stat { bottom: 15px; left: 58%; transform: translateX(-50%); opacity: 0; }

    .actor-name { font-size: 0.8rem; color: #fff; font-weight: bold; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-hp-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; border: 1px solid #222; }
    .mini-hp-fill { height: 100%; background: #ef5350; transition: width 0.3s; }
    
    .visual-stage.town-mode .actor-box.player { left: 50%; transform: translate(-50%, -50%) scale(1.1); }
    .visual-stage.town-mode .actor-box.enemy { display: none; }
    .visual-stage.town-mode .player-stat { top: auto; bottom: 20px; left: 50%; }
    .visual-stage.town-mode .enemy-stat { display: none; }
    
    .visual-stage.battle-mode .actor-box.enemy { opacity: 1; }
    .visual-stage.battle-mode .enemy-stat { opacity: 1; }

    .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 
        10%, 90% { transform: translate3d(-1px, -50%, 0); } 
        20%, 80% { transform: translate3d(1px, -50%, 0); } 
        30%, 50%, 70% { transform: translate3d(-2px, -50%, 0); } 
        40%, 60% { transform: translate3d(2px, -50%, 0); } 
    }

    /* ë¡œê·¸ì°½ */
    .log-container { height: 70px; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; padding: 8px; overflow-y: auto; font-size: 0.8rem; flex-shrink: 0; box-shadow: inset 0 0 10px #000; margin-bottom: 6px; }
    .log-line { margin-bottom: 3px; border-bottom: 1px solid #252525; padding-bottom: 1px; line-height: 1.25; }
    .log-turn { color: #fbc02d; font-weight: bold; margin-top: 8px; border-top: 1px solid #444; padding-top: 4px; text-align: center; }
    .dmg { color: #ff5252; } .heal { color: #69f0ae; } .info { color: #4fc3f7; } .rose { color: #f06292; } .fire { color: #ffab91; } .holy { color: #fff59d; } .star { color: #e1f5fe; text-shadow: 0 0 3px #0288d1; }

    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
    #game-controls { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        min-height: 0; 
        overflow: hidden; 
    }
    
    #battle-menu {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .controls { 
        flex: 1; 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 6px; 
        padding: 2px 2px 10px 2px;
        overflow-y: auto; 
        min-height: 0;
    }
    .controls.menu-mode { grid-template-columns: 1fr; }
    
    button { background: #333; border: 1px solid #555; color: #eee; padding: 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.1s; touch-action: manipulation; min-height: 52px; }
    button:active { background: #555; transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-atk { background: linear-gradient(135deg, #4a148c, #7b1fa2); border-color: #8e24aa; }
    .btn-skill { background: linear-gradient(135deg, #0d47a1, #1976d2); border-color: #2196f3; }
    .btn-def { background: linear-gradient(135deg, #1b5e20, #388e3c); border-color: #4caf50; }
    .btn-ult { background: linear-gradient(135deg, #b71c1c, #d32f2f); border-color: #f44336; grid-column: span 2; font-weight: bold; border: 1px solid #ffcdd2; }
    .skill-sub { display: block; font-size: 0.7rem; color: #ccc; margin-top: 1px; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444; width: 85%; max-width: 400px; text-align: center; max-height: 85vh; overflow-y: auto; }
    .char-select-btn { width: 100%; margin: 6px 0; padding: 16px; text-align: left; background: #333; }
</style>
</head>
<body>

<div class="header">Turn RPG: Legend Edition v9.3</div>

<div class="container">
    <div class="status-panel">
        <div class="status-top">
            <div class="char-info">
                <div id="char-name">ìºë¦­í„°</div>
                <div style="font-size:0.8rem; color:#aaa;" id="char-lvl">Lv.1</div>
            </div>
            <div class="stat-bars">
                <div class="bar-box"><div id="hp-bar" class="bar-fill hp-bar" style="width:100%"></div><span id="hp-text" class="bar-text">0/0</span></div>
                <div class="bar-box"><div id="mp-bar" class="bar-fill mp-bar" style="width:50%"></div><span id="mp-text" class="bar-text">0/0</span></div>
            </div>
        </div>
        <div class="stat-detail">
            <span>âš”ï¸ ATK: <span id="ui-atk" style="color:#ef9a9a">0</span></span>
            <span>ğŸ”® MATK: <span id="ui-matk" style="color:#90caf9">0</span></span>
            <span>ğŸ›¡ï¸ DEF: <span id="ui-def" style="color:#a5d6a7">0</span></span>
            <span>ğŸ”° MDEF: <span id="ui-mdef" style="color:#ce93d8">0</span></span>
        </div>
        <div id="artifact-list" class="artifact-box">ìœ ë¬¼: ì—†ìŒ</div>
        <div id="extra-ui" style="display:none; font-size:0.8rem; margin-top:4px; text-align:center;"></div>
    </div>

    <div id="main-stage" class="visual-stage town-mode">
        <div id="player-actor" class="actor-box player">
            <div class="portrait" id="player-img">ğŸ§™â€â™‚ï¸</div> 
        </div>
        <div id="enemy-actor" class="actor-box enemy">
            <div class="portrait" id="enemy-img">ğŸ’€</div>
        </div>
        <div class="mini-stat player-stat">
            <div class="actor-name" id="vis-p-name">Player</div>
            <div class="mini-hp-bg"><div id="vis-p-hp" class="mini-hp-fill" style="width:100%"></div></div>
        </div>
        <div class="mini-stat enemy-stat">
            <div class="actor-name" id="vis-e-name">Monster</div>
            <div class="mini-hp-bg"><div id="vis-e-hp" class="mini-hp-fill" style="width:100%"></div></div>
        </div>
    </div>

    <div id="game-controls">
        <div id="town-menu" class="controls menu-mode" style="display:none;">
            <div style="text-align:center; margin-bottom:10px; color:#ffd700;">
                í‰í™”ë¡œìš´ ë§ˆì„ (ê³¨ë“œ: <span id="ui-gold" style="font-weight:bold;">0</span> G)
            </div>
            <button onclick="enterDungeon(1)">ğŸŸ¢ ì†ì‚­ì´ëŠ” ë™êµ´ (Lv.1~3)</button>
            <button onclick="enterDungeon(2)">ğŸŸ¡ ê²€ì€ ì•ˆê°œ ìˆ² (Lv.4~7)</button>
            <button onclick="enterDungeon(3)">ğŸ”´ ìŠí˜€ì§„ ê³ ì„± (Lv.8~10)</button>
            <button onclick="enterEvent()">ğŸŸ£ í˜¼ëˆì˜ í‹ˆ (Lv.11~16)</button>
            <button onclick="enterDungeon(5)" style="background: linear-gradient(135deg, #4fc3f7, #0288d1); border-color:#29b6f6; color:#fff;">â„ï¸ ì˜ê²ì˜ ë¹™í•˜ (Lv.17~20)</button>
            <button onclick="enterDungeon(6)" style="background: linear-gradient(135deg, #cfd8dc, #546e7a); border-color:#90a4ae; color:#263238; font-weight:bold;">â˜ï¸ ì²œìƒì˜ ê³„ë‹¨ (Lv.21~25)</button>
            <button onclick="openShop()" style="background:#424242;">ğŸ›’ ìƒì  / ìŠ¤í‚¬ ê´€ë¦¬</button>
            <button onclick="resetAllArtifacts()" style="background:#3e2723; border-color:#5d4037;">ğŸ•°ï¸ ì‹œê°„ì˜ ì—­í–‰ (ìœ ë¬¼ ë¦¬ì…‹)</button>
            <button onclick="confirmResetGame()" style="background:#212121; border-color:#000; color:#ef5350; margin-top:5px;">â˜ ï¸ ê²Œì„ ì´ˆê¸°í™” (Rebirth)</button>
        </div>

        <div id="battle-menu" style="display:none; width:100%;">
            <div id="log-box" class="log-container"></div>
            <div id="action-btns" class="controls"></div>
        </div>
    </div>
</div>

<div id="shop-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:#fff; border-bottom:1px solid #555; padding-bottom:10px;">ì •ë¹„ì†Œ</h2>
        <div style="margin-bottom:15px; color:#ffd700; font-size:1.1rem;">ê³¨ë“œ: <span id="shop-gold">0</span> G</div>
        <h4 style="text-align:left; color:#81d4fa;">ëŠ¥ë ¥ì¹˜ ê°•í™”</h4>
        <button onclick="upgradeMana()" style="width:100%; margin-bottom:5px;">ë§ˆë‚˜ íš¨ìœ¨ ê°•í™” <span id="mana-cost" class="skill-sub"></span></button>
        <button onclick="healFull()" style="width:100%; margin-bottom:15px;">ì „ì²´ íšŒë³µ <span class="skill-sub">ë¹„ìš©: 50 G</span></button>
        <h4 style="text-align:left; color:#ffcc80;">ì¥ë¹„ ê°•í™”</h4>
        <button onclick="buyEquip('weapon')" style="width:100%; margin-bottom:5px;">ë¬´ê¸° ê°•í™” <span id="weapon-cost" class="skill-sub"></span></button>
        <button onclick="buyEquip('armor')" style="width:100%; margin-bottom:15px;">ë°©ì–´êµ¬ ê°•í™” <span id="armor-cost" class="skill-sub"></span></button>
        <h4 style="text-align:left; color:#a5d6a7;">ìŠ¤í‚¬ ìŠµë“</h4>
        <div id="skill-shop-list" style="display:grid; grid-template-columns:1fr; gap:6px; margin-bottom:15px;"></div>
        <button onclick="closeShop()" style="background:#555; margin-top:10px;">ë‚˜ê°€ê¸°</button>
    </div>
</div>

<div id="char-modal" class="modal active">
    <div class="modal-content">
        <div class="title-text" style="font-size:1.2rem; margin-bottom:15px;">ìš´ëª… ì„ íƒ</div>
        <button class="char-select-btn" onclick="selectChar('luna')">
            <span style="color:#b39ddb; font-size:1.1rem; font-weight:bold;">ğŸŒ™ ë£¨ë‚˜ (ì•”ì‚´ì)</span>
            <span class="skill-sub">íšŒí”¼ / ì¹˜ëª…íƒ€ / ìœ ë¦¬ëŒ€í¬</span>
        </button>
        <button class="char-select-btn" onclick="selectChar('zeke')">
            <span style="color:#ef9a9a; font-size:1.1rem; font-weight:bold;">ğŸ”¥ ì§€í¬ (ê¸°ì‚¬ë‹¨ì¥)</span>
            <span class="skill-sub">ê·¼ì„± / ë°˜ê²© / í•˜ì´ë¸Œë¦¬ë“œ íƒ±ì»¤</span>
        </button>
        <button class="char-select-btn" onclick="selectChar('jasmine')">
            <span style="color:#fff59d; font-size:1.1rem; font-weight:bold;">â˜€ï¸ ììŠ¤ë¯¼ (ë§ˆë²•ì‚¬)</span>
            <span class="skill-sub">ë§ˆë‚˜ / ìš´ì˜ / ì»¨íŠ¸ë¡¤</span>
        </button>
        <button class="char-select-btn" onclick="selectChar('queen')">
            <span style="color:#f48fb1; font-size:1.1rem; font-weight:bold;">ğŸŒ¹ ì—¬ì™• (ë§ˆë²•ê²€ì‚¬)</span>
            <span class="skill-sub">ìŠ¤íƒ / ì§€ì†ë”œ / ìš´ì˜</span>
        </button>
        <button class="char-select-btn" onclick="selectChar('rumi')">
            <span style="color:#81d4fa; font-size:1.1rem; font-weight:bold;">âœ¨ ë£¨ë¯¸ (ëŒ€í˜„ì)</span>
            <span class="skill-sub">í˜•íƒœ ë³€í™˜ / í•˜ì´ë¸Œë¦¬ë“œ / ê¿ˆì˜ ê²°ì •</span>
        </button>
    </div>
</div>

<div id="alert-modal" class="modal">
    <div class="modal-content" style="width:70%;">
        <div id="alert-msg" style="color:#fff; margin-bottom:20px;">ì•Œë¦¼</div>
        <button onclick="document.getElementById('alert-modal').classList.remove('active')" style="width:100%; padding:10px; background:#444;">í™•ì¸</button>
    </div>
</div>

<script>
/* =========================================
   1. ë°ì´í„°ë² ì´ìŠ¤
   ========================================= */
const EQUIP_COSTS = [1000, 3000, 5000, 10000, 20000, 30000, 70000];

const EQUIP_STATS = {
    zeke: { 
        weapon: [
            {atk:20,matk:15}, {atk:30,matk:25}, {atk:45,matk:35}, 
            {atk:70,matk:55}, {atk:100,matk:80}, {atk:130,matk:100}, {atk:180,matk:125}
        ], 
        armor: [
            {def:10,mdef:5}, {def:20,mdef:10}, {def:40,mdef:20}, 
            {def:60,mdef:30}, {def:90,mdef:50}, {def:110,mdef:80}, {def:130,mdef:95}
        ] 
    },
    jasmine: { 
        weapon: [
            {atk:15,matk:20}, {atk:25,matk:40}, {atk:35,matk:60}, 
            {atk:50,matk:90}, {atk:70,matk:120}, {atk:90,matk:160}, {atk:125,matk:210}
        ], 
        armor: [
            {def:5,mdef:10}, {def:5,mdef:10}, {def:15,mdef:30}, 
            {def:25,mdef:50}, {def:45,mdef:90}, {def:55,mdef:120}, {def:65,mdef:170}
        ] 
    },
    luna: { 
        weapon: [ 
            {atk:15,matk:15}, {atk:30,matk:20}, {atk:35,matk:40}, 
            {atk:60,matk:55}, {atk:90,matk:85}, {atk:120,matk:115}, {atk:165,matk:155}
        ], 
        armor: [
            {def:5,mdef:5}, {def:20,mdef:15}, {def:25,mdef:25}, 
            {def:40,mdef:45}, {def:60,mdef:70}, {def:80,mdef:90}, {def:100,mdef:100}
        ] 
    },
    queen: { 
        weapon: [
            {atk:15,matk:15}, {atk:30,matk:30}, {atk:45,matk:45}, 
            {atk:70,matk:70}, {atk:95,matk:95}, {atk:140,matk:140}, {atk:180,matk:180}
        ], 
        armor: [
            {def:10,mdef:10}, {def:25,mdef:25}, {def:35,mdef:35}, 
            {def:50,mdef:50}, {def:65,mdef:65}, {def:80,mdef:80}, {def:100,mdef:100}
        ] 
    },
    rumi: { 
        weapon: [ 
            {atk:15,matk:20}, {atk:25,matk:35}, {atk:35,matk:50}, 
            {atk:55,matk:75}, {atk:80,matk:110}, {atk:110,matk:145}, {atk:145,matk:185}
        ], 
        armor: [ 
            {def:10,mdef:10}, {def:20,mdef:20}, {def:30,mdef:30}, 
            {def:50,mdef:50}, {def:70,mdef:70}, {def:95,mdef:95}, {def:120,mdef:120}
        ] 
    }
};

const BASE_ARTIFACTS = [
    { id: 'vit_stone', name: "ìƒëª…ì˜ ëŒ", desc: "ìµœëŒ€ HP +20%", effect: 'stat_hp', val: 0.2 },
    { id: 'mana_crys', name: "ë§ˆë‚˜ ìˆ˜ì •", desc: "ìµœëŒ€ MP +20%", effect: 'stat_mp', val: 0.2 },
    { id: 'str_ring', name: "ì „ì‚¬ì˜ ë°˜ì§€", desc: "ë¬¼ë¦¬ ê³µê²© +10%", effect: 'stat_atk', val: 0.1 },
    { id: 'wis_ring', name: "í˜„ìì˜ ë°˜ì§€", desc: "ë§ˆë²• ê³µê²© +10%", effect: 'stat_matk', val: 0.1 },
    { id: 'iron_shield', name: "ê°•ì²  ë°©íŒ¨", desc: "ë¬¼ë¦¬ ë°©ì–´ +10%", effect: 'stat_def', val: 0.1 },
    { id: 'magic_cloak', name: "ë§ˆë²• ë§í† ", desc: "ë§ˆë²• ë°©ì–´ +10%", effect: 'stat_mdef', val: 0.1 },
    { id: 'eagle_eye', name: "ë§¤ì˜ ëˆˆ", desc: "ì¹˜ëª…íƒ€ í™•ë¥  +15%", effect: 'stat_crit', val: 0.15 },
    { id: 'wind_boots', name: "ë°”ëŒì˜ ì¥í™”", desc: "íšŒí”¼ìœ¨ +5%", effect: 'stat_eva', val: 0.05 },
    { id: 'gold_pocket', name: "í™©ê¸ˆ ì£¼ë¨¸ë‹ˆ", desc: "ê³¨ë“œ íšë“ +20%", effect: 'gold_up', val: 0.2 },
    { id: 'mana_gem', name: "ì‹œì‘ì˜ ë³´ì„", desc: "ì‹œì‘ MP +30", effect: 'start_mp', val: 30 },
    { id: 'cursed_sword', name: "ì €ì£¼ë°›ì€ ê²€", desc: "í”¼í•´ëŸ‰ +30%, ë°›ëŠ” í”¼í•´ +20%", effect: 'high_risk_dmg', val: 0.3 },
    { id: 'blood_pact', name: "í”¼ì˜ ê³„ì•½", desc: "ìµœëŒ€ HP -20%, ATK/MATK +20%", effect: 'blood_pact', val: 0.2 },
    { id: 'reckless', name: "ë¬´ëª¨í•œ ëŒì§„", desc: "ë°©ì–´ -30%, ì¹˜ëª…íƒ€ í”¼í•´ +80%", effect: 'reckless', val: 0.8 },
    { id: 'mask_madness', name: "ê´‘ê¸°ì˜ ê°€ë©´", desc: "ì£¼ëŠ” í”¼í•´ +100%, ë°›ëŠ” í”¼í•´ +50%", effect: 'high_risk_dmg_ex', val: 1.0 },
    { id: 'vampire', name: "í¡í˜ˆì˜ ì´ë¹¨", desc: "ê°€í•œ í”¼í•´ì˜ 5% íšŒë³µ", effect: 'vampire', val: 0.05 },
    { id: 'mana_engine', name: "ë§ˆë‚˜ ì—”ì§„", desc: "í„´ ì¢…ë£Œ ì‹œ MP +10", effect: 'mana_engine', val: 10 },
    { id: 'thorns', name: "ê°€ì‹œ ê°‘ì˜·", desc: "ë°›ì€ ë¬¼ë¦¬ í”¼í•´ 10% ë°˜ì‚¬", effect: 'reflect_phy', val: 0.1 },
    { id: 'guardian_angel', name: "ìˆ˜í˜¸ì²œì‚¬ì˜ ê¹ƒí„¸", desc: "ì‚¬ë§ ì‹œ 1íšŒ ë¶€í™œ (HP 50%)", effect: 'revive_once', val: 0.5 },
    { id: 'dragon_heart', name: "ìš©ì˜ ì‹¬ì¥", desc: "ìµœëŒ€ HP +40%, ë¬¼ë¦¬ê³µê²© +20%", effect: 'dragon_heart', val: 0.4 },
    { id: 'ancient_book', name: "ê³ ëŒ€ì˜ ë§ˆë„ì„œ", desc: "ìµœëŒ€ MP +40%, ë§ˆë²•ê³µê²© +20%", effect: 'ancient_book', val: 0.4 },
    { id: 'golden_sun', name: "í™©ê¸ˆì˜ íƒœì–‘[ì—í”½]", desc: "ê³µ/ë§ˆê³µ +25%, ë§ˆë²•ë°©ì–´ -20%", effect: 'golden_sun', val: 0.25 },
    { id: 'beelzebub', name: "ë§ˆì‹ ê¸° ë²¨ì œë·”íŠ¸[ì—í”½]", desc: "ê³µê²©/ì¹˜ëª…í”¼í•´ +50%, ë°©ì–´ -30%", effect: 'beelzebub', val: 0.5 },
    { id: 'iris', name: "ì‹ ê¸° ì•„ì´ë¦¬ìŠ¤[ì—í”½]", desc: "ë§ˆê³µ/ë§ˆë°© +50%", effect: 'iris', val: 0.5 },
    { id: 'royal_crown', name: "ë¡œì—´ í¬ë¼ìš´[ì—í”½]", desc: "ëª¨ë“  ëŠ¥ë ¥ì¹˜ +20% (ì—¬ì™•: ì‹œì‘ì‹œ ì¥ë¯¸+5)", effect: 'all_stat', val: 0.2 }
];

const NEW_ARTIFACTS = {
    zeke: { id: 'will_protect', name: "ìˆ˜í˜¸ì˜ ì˜ì§€", desc: "ë°©ì–´ë ¥/ë§ˆë²•ë°©ì–´ë ¥ +30%", effect: 'stat_def_mdef', val: 0.3 },
    luna: { id: 'moon_neck', name: "ì›”ê´‘ì˜ ëª©ê±¸ì´", desc: "ì¹˜ëª…íƒ€ìœ¨ +10%, ì¹˜ëª…íƒ€í”¼í•´ +30%", effect: 'crit_critdmg', val: 0.3 },
    jasmine: { id: 'old_diary', name: "ì˜¤ë˜ëœ ì¼ê¸°ì¥", desc: "ë§ˆë²•ê³µê²©ë ¥/ìµœëŒ€MP +30%", effect: 'matk_mp', val: 0.3 },
    queen: { id: 'queen_crest', name: "ì—¬ì™•ì˜ ë¬¸ì–‘", desc: "ê³µê²©ë ¥/ë§ˆë²•ê³µê²©ë ¥ +30%", effect: 'atk_matk', val: 0.3 },
    rumi: { id: 'precious_dream', name: "ì†Œì¤‘í•œ ê¿ˆ", desc: "ê³µê²©ë ¥/ìƒëª…ë ¥ +30%", effect: 'atk_hp', val: 0.3 }
};

let ARTIFACTS = JSON.parse(JSON.stringify(BASE_ARTIFACTS));

const CHAR_DATA = {
    luna: {
        name: "ë£¨ë‚˜", hp: 540, mp: 100, mpRegen: 10, atk: 65, matk: 55, def: 30, mdef: 35, baseCrit: 0.15, baseCritDmg: 1.5, baseEva: 0.1, fixedMp: true,
        skills: {
            'basic': { name: "ê¸°ë³¸ ê³µê²©", type: 'phy', cost: 0, power: 1.0, price: 0, desc: "ê¸°ë³¸ ë¬¼ë¦¬ ê³µê²©", effect: '' },
            'genocide': { name: "ì œë…¸ì‚¬ì´ë“œ ìŠ¤íƒ­", type: 'phy', cost: 10, power: 0.5, price: 0, desc: "ì´ë²ˆ í„´ íšŒí”¼ìœ¨ +50%", effect: 'evasion_50' },
            'crosscut': { name: "í¬ë¡œìŠ¤ ì»·", type: 'phy', cost: 20, power: 1.3, price: 1000, desc: "ì¹˜ëª…íƒ€ ì‹œ ì•”í‘ 3ìŠ¤íƒ", effect: 'darkness' },
            'assassin': { name: "ì–´ìŒ”ì‹  ë„¤ì¼", type: 'phy', cost: 30, power: 1.5, price: 5000, desc: "ì•”í‘ ìŠ¤íƒë‹¹ ì¹˜ëª…íƒ€ìœ¨ ì¦ê°€", effect: 'finisher' },
            'phantom': { name: "íŒ¬í…€ ë ˆì´ë“œ", type: 'phy', cost: 20, power: 1.4, price: 1000, desc: "ë‹¤ìŒ í„´ ì  ë§ˆë°© ê°ì†Œ", effect: 'mdef_down' },
            'dancing': { name: "ëŒ„ì‹± ëŒ€ê±°", type: 'phy', cost: 30, power: 0.6, price: 5000, desc: "íšŒí”¼ íšŸìˆ˜ë§Œí¼ ì¶”ê°€íƒ€", effect: 'multi_hit' },
            'shadow': { name: "ì„€ë„ìš° ë³¼", type: 'mag', cost: 20, power: 1.1, price: 1000, desc: "ì•”í‘ ë¶€ì—¬", effect: 'darkness' },
            'veil': { name: "ë² ì¼ ì˜¤ë¸Œ ë‹¤í¬ë‹ˆìŠ¤", type: 'mag', cost: 30, power: 1.0, price: 5000, desc: "3í„´ íšŒí”¼ +40%", effect: 'eva_buff' },
            'meteor': { name: "ë‹¤í¬ ë©”í…Œì˜¤", type: 'mag', cost: 40, power: 3.5, price: 10000, desc: "ë‹¤ìŒ í„´ í–‰ë™ë¶ˆê°€", effect: 'self_stun' },
            'evasion': { name: "íšŒí”¼ íƒœì„¸", type: 'sup', cost: 10, power: 0, price: 0, desc: "ë‹¤ìŒ í„´ íšŒí”¼ +50%", effect: 'next_eva' },
            'instinct': { name: "ì¸ìŠ¤íŒ…íŠ¸", type: 'sup', cost: 10, power: 0, price: 5000, desc: "5í„´ íšŒí”¼+25%/í”¼í•´+20%", effect: 'instinct' },
            'adrenaline': { name: "ì•„ë“œë ˆë‚ ë¦°", type: 'sup', cost: 20, power: 0, price: 5000, desc: "4í„´ ì¹˜ëª…ëŒ/í”¼í•´ ì¦ê°€", effect: 'adrenaline' },
            'eclipse': { name: "ì´í´ë¦½ìŠ¤", type: 'ult', cost: 50, power: 2.9, price: 20000, desc: "í™•ì • ì¹˜ëª…íƒ€ (ë¬¼ë¦¬)", effect: 'guarantee_crit' },
            'lunablade': { name: "ë£¨ë‚˜ ë¸”ë ˆì´ë“œ", type: 'ult', cost: 50, power: 3.2, price: 20000, desc: "ì´ë²ˆ í„´ ì™„ì „íšŒí”¼", effect: 'perfect_eva' }
        }
    },
    zeke: {
        name: "ì§€í¬", hp: 620, mp: 120, mpRegen: 10, atk: 60, matk: 45, def: 60, mdef: 50, baseCrit: 0.1, baseCritDmg: 1.5, baseEva: 0.05, fixedMp: true,
        skills: {
            'basic': { name: "ê¸°ë³¸ ê³µê²©", type: 'phy', cost: 0, power: 1.0, price: 0, desc: "ê¸°ë³¸ ë¬¼ë¦¬ ê³µê²©", effect: '' },
            'heavy': { name: "í—¤ë¹„ ì„íŒ©íŠ¸", type: 'phy', cost: 20, power: 1.2, price: 1000, desc: "ìƒì€ ì²´ë ¥ ë¹„ë¡€ í”¼í•´", effect: 'hp_reverse_mid' },
            'carnage': { name: "ì¹´ë‹ˆì§€", type: 'phy', cost: 0, power: 1.4, price: 1000, desc: "HP 10% ì†Œëª¨", effect: 'hp_cost' },
            'flameshot': { name: "í”Œë ˆì„ ìƒ·", type: 'mag', cost: 10, power: 1.1, price: 1000, desc: "3í„´ ë¬¼ë°© 20% ê°ì†Œ", effect: 'def_down' },
            'undying': { name: "ì–¸ë‹¤ì‰", type: 'sup', cost: 10, power: 0, price: 5000, desc: "ë¶ˆì‚¬ / ì„±ê³µì‹œ ê³µ2ë°°", effect: 'immortal' },
            'wild': { name: "ì™€ì¼ë“œ ì“°ë˜ì‰¬", type: 'phy', cost: 30, power: 2.8, price: 5000, desc: "ë‹¤ìŒ í„´ ë‚´ ë°©ì–´ë ¥ 0", effect: 'self_def_zero' },
            'divine': { name: "ë””ë°”ì¸ ì•„ë¨¸", type: 'sup', cost: 20, power: 0, price: 5000, desc: "4í„´ ë°©ì–´+30% / í”¼ê²©ì‹œ ìŠ¤íƒ", effect: 'divine_buff' },
            'ignis': { name: "ì´ê·¸ë‹ˆìŠ¤ ìŠ¤ë§¤ì‹œ", type: 'phy', cost: 30, power: 1.7, price: 5000, desc: "í™”ì—¼ ì¸ì±ˆíŠ¸ ì‹œ 1.4ë°°", effect: 'fire_combo_new' },
            'enchant': { name: "íŒŒì´ì–´ ì¸ì±ˆíŠ¸", type: 'sup', cost: 30, power: 0, price: 5000, desc: "5í„´ ë¬¼ê³µ ì‹œ ë§ˆë²• ì¶”ê°€íƒ€", effect: 'enchant_buff' },
            'guard': { name: "ê°€ë“œ", type: 'sup', cost: 10, power: 0, price: 0, desc: "ì´ë²ˆ í„´ í”¼í•´ 70% ê°ì†Œ", effect: 'guard_70' },
            'divineblade': { name: "ë””ë°”ì¸ ë¸”ë ˆì´ë“œ", type: 'phy', cost: 40, power: 4.2, price: 10000, desc: "2í„´ ì°¨ì§€/ìŠ¤íƒì†Œëª¨", effect: 'charge_divine' },
            'prominence': { name: "í”„ë¡œë¯¸ë„ŒìŠ¤", type: 'mag', cost: 40, power: 2.1, price: 10000, desc: "3í„´ ë¬¼ë°© 20% ê°ì†Œ", effect: 'def_down' },
            'ragnarok': { name: "ë¼ê·¸ë‚˜ë¡œí¬", type: 'ult', cost: 50, power: 2.0, price: 20000, desc: "ìƒì€ ì²´ë ¥ ë¹„ë¡€ ëŒ(ë¬¼ë¦¬)", effect: 'hp_reverse' },
            'castle': { name: "ê¸°ê°„í‹± ìºìŠ¬", type: 'ult', cost: 50, power: 1.8, price: 20000, desc: "ì‚¬ìš© íšŸìˆ˜ë§Œí¼ ê°•í™” / ë°©ì–´+100%", effect: 'stack_ult_new' }
        }
    },
    jasmine: {
        name: "ììŠ¤ë¯¼", hp: 480, mp: 300, mpRegen: 15, atk: 30, matk: 85, def: 40, mdef: 60, baseCrit: 0.1, baseCritDmg: 1.5, baseEva: 0.1, fixedMp: true,
        skills: {
            'basic': { name: "ê¸°ë³¸ ê³µê²©", type: 'phy', cost: 0, power: 1.0, price: 0, desc: "ê¸°ë³¸ ë¬¼ë¦¬ ê³µê²©", effect: '' },
            'smite': { name: "í™€ë¦¬ ìŠ¤ë§ˆì´íŠ¸", type: 'phy', cost: 10, power: 1.3, price: 1000, desc: "ì €ë¹„ìš© ë¬¼ë¦¬", effect: '' },
            'rod': { name: "ì €ì§€ë¨¼íŠ¸ ë¡œë“œ", type: 'phy', cost: 20, power: 1.4, price: 5000, desc: "3í„´ ë¬¼ë°© ê°ì†Œ", effect: 'def_down' },
            'lance': { name: "ì—í…Œë¥´ ëœìŠ¤", type: 'phy', cost: 30, power: 1.7, price: 10000, desc: "3í„´ ë§ˆë°© ê°ì†Œ", effect: 'mdef_down' },
            'holyball': { name: "í™€ë¦¬ ë³¼", type: 'mag', cost: 30, power: 1.4, price: 0, desc: "ê¸°ë³¸ ë§ˆë²•", effect: '' },
            'holyray': { name: "í™€ë¦¬ ë ˆì´", type: 'mag', cost: 60, power: 2.4, price: 1000, desc: "ìˆœê°„ ëˆ„í‚¹", effect: '' },
            'sunfire': { name: "ì„ íŒŒì´ì–´", type: 'mag', cost: 50, power: 2.8, price: 5000, desc: "HP 20% ì†Œëª¨", effect: 'hp_cost_20' },
            'judgment': { name: "ì €ì§€ë¨¼íŠ¸", type: 'mag', cost: 70, power: 3.5, price: 5000, desc: "ëª…ì¤‘ë¥  70%", effect: 'miss_chance' },
            'sanctuary': { name: "ìƒì¸„ì–´ë¦¬", type: 'sup', cost: 70, power: 0, price: 5000, desc: "3í„´ ë§ˆë²• ë°˜ì‚¬", effect: 'reflect' },
            'absolute': { name: "ì•±ì†”ë£¨íŠ¸ ë¼ì´íŠ¸", type: 'mag', cost: 70, power: 1.5, price: 10000, desc: "ì—°ì† ì‚¬ìš©ì‹œ ê°•í™”", effect: 'stack_dmg' },
            'magicguard': { name: "ë§¤ì§ ê°€ë“œ", type: 'sup', cost: 30, power: 0, price: 0, desc: "ì´ë²ˆ í„´ ë§ˆë²•ë¬´íš¨", effect: 'null_mag' },
            'barrier': { name: "ë°°ë¦¬ì–´", type: 'sup', cost: 30, power: 0, price: 5000, desc: "ì´ë²ˆ í„´ ë¬¼ë¦¬ë¬´íš¨", effect: 'null_phy' },
            'meditation': { name: "ë©”ë””í…Œì´ì…˜", type: 'sup', cost: 30, power: 0, price: 10000, desc: "ë¦¬ì  UP/ë§ˆë²•ê³µê²©DOWN (4í„´)", effect: 'medi' },
            'theholy': { name: "ë” í™€ë¦¬", type: 'ult', cost: 100, power: 5.5, price: 20000, desc: "ë‹¤ìŒ í„´ í–‰ë™ë¶ˆê°€ / ì—¬ì‹ ê°•ë¦¼ ì‹œ ê·¹ë”œ", effect: 'self_stun' },
            'goddess': { name: "ì—¬ì‹  ê°•ë¦¼", type: 'ult', cost: 200, power: 0, price: 25000, desc: "HP/ìƒíƒœ ë¦¬ì…‹, ë²„í”„", effect: 'reset_buff' }
        }
    },
    queen: {
        name: "ì—¬ì™•", hp: 550, mp: 120, mpRegen: 12, atk: 55, matk: 55, def: 35, mdef: 45, baseCrit: 0.10, baseCritDmg: 1.5, baseEva: 0.05, fixedMp: true,
        skills: {
            'basic': { name: "ê¸°ë³¸ ê³µê²©", type: 'phy', cost: 0, power: 1.0, price: 0, desc: "ê¸°ë³¸ ë¬¼ë¦¬ ê³µê²©", effect: '' },
            'thornwhip': { name: "Vine Whip", type: 'phy', cost: 10, power: 1.2, price: 1000, desc: "ì¥ë¯¸ 1ìŠ¤íƒ", effect: 'add_rose_1' },
            'roseseed': { name: "Rose Shot", type: 'mag', cost: 10, power: 1.1, price: 1000, desc: "ì¥ë¯¸ 1ìŠ¤íƒ", effect: 'add_rose_1' },
            'petaldance': { name: "Flower Dance", type: 'phy', cost: 20, power: 1.3, price: 3000, desc: "3í„´ íšŒí”¼ +20%", effect: 'eva_buff' },
            'sharpness': { name: "Royal Focus", type: 'mag', cost: 20, power: 1.3, price: 3000, desc: "3í„´ ì¹˜ëª… +25%", effect: 'crit_buff' },
            'thornarmor': { name: "Thorn Guard", type: 'sup', cost: 10, power: 0, price: 0, desc: "ì´ë²ˆ í„´ í”¼í•´ 50% ê°ì†Œ", effect: 'dmg_red_50' },
            'withering': { name: "Cruel Thorn", type: 'phy', cost: 30, power: 1.7, price: 5000, desc: "3í„´ ì  ë§ˆë°© ê°ì†Œ", effect: 'mdef_down' },
            'wildgrowth': { name: "Wild Root", type: 'mag', cost: 30, power: 2.9, price: 10000, desc: "ì¥ë¯¸ 2ìŠ¤íƒ / ë‹¤ìŒ í„´ ë¶ˆê°€", effect: 'rose_2_self_stun' },
            'blooming': { name: "Quick Grow", type: 'sup', cost: 20, power: 0, price: 5000, desc: "ì¥ë¯¸ 3ìŠ¤íƒ ì¶©ì „", effect: 'add_rose_3' },
            'overwhelm': { name: "Rose Prison", type: 'sup', cost: 20, power: 0, price: 5000, desc: "ì¥ë¯¸3 ì†Œëª¨: ì  ìŠ¤í„´", effect: 'stun_rose_3' },
            'fatalrose': { name: "Heart Pierce", type: 'phy', cost: 40, power: 1.8, price: 10000, desc: "ì¹˜ëª…íƒ€ ì‹œ ì¥ë¯¸ 6ìŠ¤íƒ", effect: 'crit_rose_6' },
            'royalbloom': { name: "Royal Bloom", type: 'sup', cost: 30, power: 0, price: 5000, desc: "3í„´ ê³µê²©/ë§ˆê³µ 50% ì¦ê°€ (ì¢…ë£Œì‹œ ì†Œë©¸)", effect: 'royal_bloom' },
            'queensgarden': { name: "Queen's Domain", type: 'ult', cost: 50, power: 2.5, price: 20000, desc: "3í„´ íŒ¨ì‹œë¸Œ í”¼í•´ 2ë°°", effect: 'passive_boost' },
            'funeral': { name: "Finale", type: 'ult', cost: 50, power: 5.0, price: 20000, desc: "ìŠ¤íƒ í­ë°œ", effect: 'rose_finisher' }
        }
    },
    rumi: {
        name: "ë£¨ë¯¸", hp: 550, mp: 240, mpRegen: 10, atk: 50, matk: 60, def: 40, mdef: 60, baseCrit: 0.05, baseCritDmg: 1.5, baseEva: 0.05, fixedMp: true,
        skills: {
            'basic': { name: "ê¸°ë³¸ ê³µê²©", type: 'phy', cost: 0, power: 1.0, price: 0, desc: "ê¸°ë³¸ ë¬¼ë¦¬ ê³µê²©", effect: '' },
            'starbarrier': { name: "ìŠ¤íƒ€ ë°°ë¦¬ì–´", type: 'sup', cost: 10, power: 0, price: 0, desc: "í”¼í•´ 50% ê°ì†Œ (ë³„: 70%)", effect: 'sage_barrier' },
            'pangpang': { name: "íŒ¡íŒ¡ í€ì¹˜", type: 'phy', cost: 10, power: 1.2, price: 0, desc: "3í„´ ì  ë§ˆë°© 20% ê°ì†Œ", effect: 'mdef_down' },
            'twinkle': { name: "íŠ¸ìœ™í´", type: 'mag', cost: 20, power: 1.0, price: 1000, desc: "í•˜ì´ë¸Œë¦¬ë“œ / ì¹˜ëª…íƒ€ì‹œ ë§ˆë‚˜íšŒë³µ", effect: 'sage_hybrid_mana' },
            'form_star': { name: "ë³„ì˜ í˜•íƒœ", type: 'sup', cost: 10, power: 0, price: 1000, desc: "[ê²°ì •1] ë°©ì–´/ë§ˆë°© 50% ì¦ê°€", effect: 'form_change_star' },
            'milkyway': { name: "ë°€í‚¤ì›¨ì´ ì—‘ìŠ¤í„°ì‹œ", type: 'mag', cost: 40, power: 2.2, price: 5000, desc: "1í„´ ì°¨ì§• / (ë¬¼ê³µ+ë§ˆê³µ)x2.2", effect: 'charge_milkyway' },
            'moonveil': { name: "ë¬¸ë¼ì´íŠ¸ ë² ì¼", type: 'mag', cost: 20, power: 1.3, price: 3000, desc: "ë‹¬: 3í„´ íšŒí”¼ 40%", effect: 'sage_moon_veil' },
            'form_moon': { name: "ë‹¬ì˜ í˜•íƒœ", type: 'sup', cost: 10, power: 0, price: 3000, desc: "[ê²°ì •1] ë§ˆê³µ50%â†‘ ë¬¼ê³µ50%â†“", effect: 'form_change_moon' },
            'godhand': { name: "ê°“ í•¸ë“œ", type: 'phy', cost: 30, power: 1.7, price: 5000, desc: "íƒœì–‘: ì¶”ê°€íƒ€ (0.4ë°°)", effect: 'sage_god_hand' },
            'silentserena': { name: "ì‚¬ì¼ëŸ°íŠ¸ ì„¸ë ˆë‚˜", type: 'mag', cost: 40, power: 2.0, price: 5000, desc: "ë‹¬: ì¶”ê°€íƒ€ (0.4ë°°)", effect: 'sage_silent' },
            'meteorsmash': { name: "ë©”í…Œì˜¤ ìŠ¤ë§¤ì‹œ", type: 'phy', cost: 40, power: 2.2, price: 10000, desc: "íƒœì–‘: 3í„´ ì¹˜ëª… 40%", effect: 'sage_meteor' },
            'milkshake': { name: "ìŠ¤íƒ€íŒŒìš°ë” ë°€í¬ì‰ì´í¬", type: 'sup', cost: 100, power: 0, price: 15000, desc: "HP30%íšŒë³µ/ë³„:10í„´ ë°©ì–´30%", effect: 'milkshake_heal' },
            'form_sun': { name: "íƒœì–‘ì˜ í˜•íƒœ", type: 'ult', cost: 50, power: 0, price: 20000, desc: "[ê²°ì •1] ë¬¼ê³µ100%â†‘ ë°©ì–´50%â†“", effect: 'form_change_sun' },
            'dreamform': { name: "ê¿ˆì˜ í˜•íƒœ", type: 'ult', cost: 50, power: 2.5, price: 20000, desc: "í˜•íƒœ ì†Œëª¨í•˜ì—¬ ê°•ë ¥í•œ íš¨ê³¼", effect: 'sage_dream_ult' }
        }
    }
};

const ENEMIES = [
    // Tier 1: ì†ì‚­ì´ëŠ” ë™êµ´
    { name: "ìŠ¬ë¼ì„", img:"", hp: 435, atk: 40, matk: 40, def: 40, mdef: 40, exp: 100, gold: 2000, tier: 1, skillName: "ì‚°ì„±ì•¡", skillType: 'mag', skillPower: 1.5, ai: 'basic' },
    { name: "ì½”ë³¼íŠ¸", img:"", hp: 540, atk: 70, matk: 50, def: 40, mdef: 40, exp: 120, gold: 2500, tier: 1, skillName: "ê°•íƒ€", skillType: 'phy', skillPower: 1.2, ai: 'basic' },
    { name: "í˜ì–´ë¦¬", img:"", hp: 620, atk: 55, matk: 75, def: 45, mdef: 55, exp: 150, gold: 3000, tier: 1, skillName: "ì—ë„ˆì§€ë³¼", skillType: 'mag', skillPower: 1.6, ai: 'basic' },
    { name: "ê³ ìŠ¤íŠ¸ í‚¹", img:"", hp: 1195, atk: 55, matk: 70, def: 50, mdef: 60, exp: 600, gold: 3500, tier: 1, skillName: "ì—ë„ˆì§€ë³¼", skillType: 'mag', skillPower: 1.6, ai: 'ghost_king', desc: "1í‹°ì–´ ë³´ìŠ¤" },
    
    // Tier 2: ê²€ì€ ì•ˆê°œ ìˆ²
    { name: "ë¯¸ë¯¹", img:"", hp: 785, atk: 85, matk: 85, def: 90, mdef: 90, exp: 300, gold: 4000, tier: 2, skillName: "ì°¨ì§€ì–´íƒ", skillType: 'phy', skillPower: 2.5, ai: 'charge' },
    { name: "ì­ì˜¤ëœí„´", img:"", hp: 865, atk: 95, matk: 115, def: 80, mdef: 85, exp: 350, gold: 4500, tier: 2, skillName: "íŒŒì´ì–´ë³¼", skillType: 'mag', skillPower: 1.7, ai: 'basic' },
    { name: "ì›¨ì–´ë² ì–´", img:"", hp: 945, atk: 120, matk: 100, def: 100, mdef: 85, exp: 400, gold: 5000, tier: 2, skillName: "ê°•íƒ€", skillType: 'phy', skillPower: 1.2, ai: 'basic' },
    { name: "ë§ˆì™•", img:"", hp: 1745, atk: 105, matk: 105, def: 95, mdef: 95, exp: 1200, gold: 5500, tier: 2, skillName: "ë‹¤í¬ë‹ˆìŠ¤", skillType: 'mag', skillPower: 1.8, ai: 'mawang', desc: "2í‹°ì–´ ë³´ìŠ¤" },
    
    // Tier 3: ìŠí˜€ì§„ ê³ ì„±
    { name: "ê³¨ë ˜", img:"", hp: 1210, atk: 150, matk: 120, def: 155, mdef: 125, exp: 700, gold: 6000, tier: 3, skillName: "ì°¨ì§€ì–´íƒ", skillType: 'phy', skillPower: 2.5, ai: 'charge' },
    { name: "ë±€íŒŒì´ì–´", img:"", hp: 1390, atk: 145, matk: 175, def: 130, mdef: 160, exp: 800, gold: 6500, tier: 3, skillName: "ë‹¤í¬ë‹ˆìŠ¤", skillType: 'mag', skillPower: 1.8, ai: 'basic' },
    { name: "ì„¸ê³„ìˆ˜", img:"", hp: 2560, atk: 135, matk: 175, def: 175, mdef: 135, exp: 2500, gold: 7500, tier: 3, skillName: "ì‚°ì„±ì•¡", skillType: 'mag', skillPower: 1.5, ai: 'tree', desc: "3í‹°ì–´ ë³´ìŠ¤" },
    
    // Tier 4: í˜¼ëˆì˜ í‹ˆ
    { name: "ê³µí—ˆì˜ ê¸°ì‚¬", img:"", hp: 2800, atk: 205, matk: 125, def: 180, mdef: 80, exp: 1300, gold: 7000, tier: 4, skillName: "ê°•íƒ€", skillType: 'phy', skillPower: 1.5, ai: 'basic' },
    { name: "í˜¼ëˆì˜ ë§ˆë²•ì‚¬", img:"", hp: 3600, atk: 145, matk: 285, def: 80, mdef: 180, exp: 1800, gold: 9500, tier: 4, skillName: "ë©”í…Œì˜¤", skillType: 'mag', skillPower: 1.7, ai: 'basic' },
    { name: "ê·¸ë¦¼ì ì¶”ì ì", img:"", hp: 5000, atk: 365, matk: 225, def: 130, mdef: 130, exp: 2500, gold: 12000, tier: 4, skillName: "ê¸°ìŠµ", skillType: 'phy', skillPower: 2.0, ai: 'basic' },
    { name: "ë§ˆì‹ ", img:"", hp: 9000, atk: 480, matk: 480, def: 250, mdef: 250, exp: 12000, gold: 25000, tier: 4, skillName: "ë‹¤í¬ë‹ˆìŠ¤", skillType: 'mag', skillPower: 1.8, ai: 'mashin', desc: "ì´ë²¤íŠ¸ ë³´ìŠ¤" },
    
    // Tier 5: ì˜ê²ì˜ ë¹™í•˜
    { 
        name: "íœë¦¬ë¥´", img:"", 
        hp: 6800, atk: 370, matk: 200, def: 220, mdef: 200, 
        exp: 3500, gold: 14000, tier: 5, 
        skillName: "ë¸”ë¦¬ìë“œ", skillType: 'mag', skillPower: 3.0, 
        ai: 'basic', desc: "ë¹™í•˜ì˜ ëŠ‘ëŒ€"
    },
    { 
        name: "ëˆˆí† ë¼", img:"", 
        hp: 6000, atk: 270, matk: 370, def: 200, mdef: 220, 
        exp: 3500, gold: 14000, tier: 5, 
        skillName: "ì•„ì´ìŠ¤ë¹”", skillType: 'mag', skillPower: 2.0, 
        ai: 'basic', desc: "ì‚¬ë‚˜ìš´ í† ë¼"
    },
    { 
        name: "ì•„ë°œë€ì²´ ë©”ì´ë“œ", img:"", 
        hp: 5500, atk: 450, matk: 450, def: 180, mdef: 180, 
        exp: 4000, gold: 14500, tier: 5, 
        skillName: "ë¸”ë¦¬ìë“œ", skillType: 'mag', skillPower: 3.0, 
        ai: 'basic', desc: "ê³µê²©í˜• ë©”ì´ë“œ"
    },
    { 
        name: "í˜¹í•œì˜ ë§ˆë…€", img:"",
        hp: 13000, atk: 550, matk: 550, def: 300, mdef: 300, 
        exp: 20000, gold: 30000, tier: 5, 
        skillName: "ì•„ì´ìŠ¤ë¹”", skillType: 'mag', skillPower: 2.0, 
        ai: 'witch', desc: "ë¹™í•˜ì˜ ì§€ë°°ì" 
    },

    // Tier 6: ì²œìƒì˜ ê³„ë‹¨ (ì•„ìŠ¤í…Œì•„ ìƒí–¥ ì ìš©)
    { 
        name: "ëŒ€ì²œì‚¬", img:"ëŒ€ì²œì‚¬.png", 
        hp: 8000, atk: 510, matk: 300, def: 270, mdef: 250, 
        exp: 6500, gold: 20000, tier: 6, 
        skillName: "ì €ì§€ë¨¼íŠ¸", skillType: 'mag', skillPower: 3.5, 
        ai: 'basic', desc: "ì²œìƒì˜ ë¬¸ì§€ê¸°"
    },
    { 
        name: "ë¼ì´íŠ¸ ì—˜ë¦¬ë©˜íƒˆ", img:"ë¼ì´íŠ¸ ì—˜ë¦¬ë©˜íƒˆ.png", 
        hp: 8500, atk: 400, matk: 580, def: 230, mdef: 300, 
        exp: 8000, gold: 23000, tier: 6, 
        skillName: "í™€ë¦¬ ë ˆì´", skillType: 'mag', skillPower: 2.0, 
        ai: 'basic', desc: "ì²œìƒì˜ ì •ë ¹"
    },
    { 
        name: "ì°½ì¡°ì‹  ì•„ìŠ¤í…Œì•„", img:"",
        hp: 27000, atk: 700, matk: 750, def: 330, mdef: 330, 
        exp: 100000, gold: 100000, tier: 6, 
        skillName: "ì²œë²Œ", skillType: 'mag', skillPower: 1.0, 
        ai: 'goddess', desc: "â˜… ì§„ ìµœì¢…ë³´ìŠ¤ â˜…" 
    }
];
/* =========================================
   2. ê²Œì„ ë¡œì§ (Game Logic)
   ========================================= */
let player = {};
let gameState = { gold: 10000, learnedSkills: [], manaLevel: 0, equipWeapon: 0, equipArmor: 0 };
let currentEnemy = null;
let turnCount = 0;
let buffs = { player: {}, enemy: {} };
let roseStack = 0; 

function myAlert(msg) {
    document.getElementById('alert-msg').innerText = msg;
    document.getElementById('alert-modal').classList.add('active');
}

function log(msg, type='info') {
    const box = document.getElementById('log-box');
    const div = document.createElement('div');
    div.className = `log-line ${type}`;
    div.innerHTML = msg;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function selectChar(charKey) {
    const data = CHAR_DATA[charKey];
    if(!data) return myAlert("ë°ì´í„° ì˜¤ë¥˜");
    player = JSON.parse(JSON.stringify(data));
    player.charKey = charKey;
    player.baseStats = { hp: data.hp, mp: data.mp, atk: data.atk, matk: data.matk, def: data.def, mdef: data.mdef };
    player.artifacts = [];
    player.level = 1;
    player.exp = 0;
    
    // ëŒ€í˜„ì ê³ ìœ  ìì›
    if(charKey === 'rumi') {
        player.dreamCrystals = 5;
    }
    
    gameState.gold = 10000;
    gameState.learnedSkills = ['basic']; // ê¸°ë³¸ ê³µê²© ìŠµë“
    
    if(charKey === 'queen') {
        gameState.learnedSkills.push('thornwhip');
        gameState.learnedSkills.push('roseseed');
    }
    if(charKey === 'zeke') {
        gameState.learnedSkills.push('heavy');
    }
    if(charKey === 'rumi') {
        gameState.learnedSkills.push('pangpang');
        gameState.learnedSkills.push('starbarrier'); // ë£¨ë¯¸: ìŠ¤íƒ€ ë°°ë¦¬ì–´ ì¶”ê°€ ìŠµë“
    }

    gameState.manaLevel = 0;
    gameState.equipWeapon = 0;
    gameState.equipArmor = 0;

    for(let k in player.skills) {
        if(player.skills[k].price === 0 && k !== 'basic' && k !== 'starbarrier' && !gameState.learnedSkills.includes(k)) {
            if(!gameState.learnedSkills.includes(k)) gameState.learnedSkills.push(k);
        }
    }

    recalcAllStats(); 
    player.hp = player.maxHp;
    player.mp = player.maxMp;

    document.getElementById('char-modal').classList.remove('active');
    document.getElementById('town-menu').style.display = 'grid'; 
    updateInfo();
}

function confirmResetGame() {
    if(confirm("ì •ë§ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ìºë¦­í„°, ë ˆë²¨, ê³¨ë“œ, ìœ ë¬¼ ë“± ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.)\n(ë‹¨, 'ì°½ì¡°ì‹  í´ë¦¬ì–´ ê¸°ë¡'ì€ ìœ ì§€ë©ë‹ˆë‹¤.)")) {
        resetGameProcess();
    }
}

function resetGameProcess() {
    // 1. ì´ˆê¸°í™”
    gameState.gold = 10000;
    roseStack = 0;
    buffs = { player: {}, enemy: {} };
    player = {};

    // 2. NG+ ìœ ë¬¼ í’€ ì„¸íŒ…
    initArtifactsWithNGPlus();

    // 3. UI ë¦¬ì…‹ ë° ìºë¦­í„° ì„ íƒì°½ ì—´ê¸°
    document.getElementById('town-menu').style.display = 'none';
    document.getElementById('battle-menu').style.display = 'none';
    document.getElementById('shop-modal').classList.remove('active');

    // í™”ë©´ ìš”ì†Œ ë¦¬ì…‹
    document.getElementById('vis-p-hp').style.width = '100%';
    document.getElementById('hp-bar').style.width = '100%';
    document.getElementById('mp-bar').style.width = '50%';
    document.getElementById('log-box').innerHTML = "";
    document.getElementById('main-stage').classList.remove('battle-mode');
    document.getElementById('main-stage').classList.add('town-mode');

    // ìºë¦­í„° ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('char-modal').classList.add('active');
    myAlert("ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œìš´ ìš´ëª…ì´ ì‹œì‘ë©ë‹ˆë‹¤)");
}

function initArtifactsWithNGPlus() {
    // ê¸°ë³¸ ìœ ë¬¼ ëª©ë¡ìœ¼ë¡œ ë³µêµ¬
    ARTIFACTS = JSON.parse(JSON.stringify(BASE_ARTIFACTS));

    // í´ë¦¬ì–´ ê¸°ë¡ í™•ì¸
    const clears = getClearHistory(); // ['zeke', 'luna', ...]

    if(clears.length === 0) return;

    // 1. ê³µí†µ ìœ ë¬¼ ì¶”ê°€ (100% í™•ë¥ )
    clears.forEach(char => {
        if(NEW_ARTIFACTS[char]) {
            // ì¤‘ë³µ ë°©ì§€ ì²´í¬ (í˜¹ì‹œ ëª¨ë¥´ë‹ˆ)
            if(!ARTIFACTS.find(a => a.id === NEW_ARTIFACTS[char].id)) {
                ARTIFACTS.push(NEW_ARTIFACTS[char]);
            }
        }
    });

    // 2. ì „ì„¤ ìœ ë¬¼ ê°•í™” (ê° ìºë¦­í„°ë³„ 10% í™•ë¥ )
    clears.forEach(char => {
        if(Math.random() < 0.1) {
            upgradeLegendaryArtifact(char);
        }
    });
}

function upgradeLegendaryArtifact(char) {
    // ì§€í¬ -> í™©ê¸ˆì˜íƒœì–‘
    if(char === 'zeke') {
        let art = ARTIFACTS.find(a => a.id === 'golden_sun');
        if(art) {
            art.name = "ì§„: í™©ê¸ˆì˜ íƒœì–‘[ì „ì„¤]";
            art.desc = "ê³µ/ë§ˆê³µ +40%, ë§ˆë²•ë°©ì–´ -30%";
            art.val = 0.40; // recalcAllStatsì—ì„œ ë³„ë„ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ valë„ ì—…ë°ì´íŠ¸
            art.effect = 'golden_sun_legend'; // íš¨ê³¼ ID ë³€ê²½
        }
    }
    // ë£¨ë‚˜ -> ë²¨ì œë·”íŠ¸
    if(char === 'luna') {
        let art = ARTIFACTS.find(a => a.id === 'beelzebub');
        if(art) {
            art.name = "ì§„: ë§ˆì‹ ê¸° ë²¨ì œë·”íŠ¸[ì „ì„¤]";
            art.desc = "ê³µê²©/ì¹˜ëª…í”¼í•´ +60%, ë°©ì–´ -30%";
            art.val = 0.60;
            art.effect = 'beelzebub_legend';
        }
    }
    // ììŠ¤ë¯¼ -> ì•„ì´ë¦¬ìŠ¤
    if(char === 'jasmine') {
        let art = ARTIFACTS.find(a => a.id === 'iris');
        if(art) {
            art.name = "ì§„: ì‹ ê¸° ì•„ì´ë¦¬ìŠ¤[ì „ì„¤]";
            art.desc = "ë§ˆê³µ/ë§ˆë°© +60%";
            art.val = 0.60;
            art.effect = 'iris_legend';
        }
    }
    // ì—¬ì™• -> ë¡œì—´í¬ë¼ìš´
    if(char === 'queen') {
        let art = ARTIFACTS.find(a => a.id === 'royal_crown');
        if(art) {
            art.name = "ì§„: ë¡œì—´ í¬ë¼ìš´[ì „ì„¤]";
            art.desc = "ì˜¬ìŠ¤íƒ¯ +30% (ì—¬ì™•: ì‹œì‘ì‹œ ì¥ë¯¸+10)";
            art.val = 0.30;
            art.effect = 'royal_crown_legend';
        }
    }
    // ë£¨ë¯¸ -> ìˆ˜í˜¸ì²œì‚¬ì˜ ê¹ƒí„¸
    if(char === 'rumi') {
        let art = ARTIFACTS.find(a => a.id === 'guardian_angel');
        if(art) {
            art.name = "ì§„: ìˆ˜í˜¸ì²œì‚¬ì˜ ê¹ƒí„¸[ì „ì„¤]";
            art.desc = "ì‚¬ë§ ì‹œ 1íšŒ ë¶€í™œ (HP 100%)";
            art.val = 1.0;
            art.effect = 'guardian_angel_legend';
        }
    }
}

function getClearHistory() {
    let history = localStorage.getItem('turnRpgClears');
    return history ? JSON.parse(history) : [];
}

function saveClear(charKey) {
    let history = getClearHistory();
    if(!history.includes(charKey)) {
        history.push(charKey);
        localStorage.setItem('turnRpgClears', JSON.stringify(history));
    }
}

function recalcAllStats() {
    if(!player || !player.baseStats) return;

    let growth = 1.0 + (player.level - 1) * 0.1;
    
    let newMaxHp = Math.floor(player.baseStats.hp * growth);
    let newMaxMp = player.fixedMp ? player.baseStats.mp : Math.floor(player.baseStats.mp * growth);
    let newAtk = Math.floor(player.baseStats.atk * growth);
    let newMatk = Math.floor(player.baseStats.matk * growth);
    let newDef = Math.floor(player.baseStats.def * growth);
    let newMdef = Math.floor(player.baseStats.mdef * growth);

    for(let i=0; i<gameState.equipWeapon; i++) {
        let s = EQUIP_STATS[player.charKey].weapon[i];
        newAtk += s.atk; 
        newMatk += s.matk;
    }
    for(let i=0; i<gameState.equipArmor; i++) {
        let s = EQUIP_STATS[player.charKey].armor[i];
        newDef += s.def; 
        newMdef += s.mdef;
    }

    player.baseCrit = CHAR_DATA[player.charKey].baseCrit;
    player.baseEva = CHAR_DATA[player.charKey].baseEva;
    player.baseCritDmg = CHAR_DATA[player.charKey].baseCritDmg;

    // ëŒ€í˜„ì íˆë“  ê¸°ë¯¹: ë ˆë²¨ë‹¹ ì¹˜ëª…íƒ€ìœ¨ 1%
    if(player.charKey === 'rumi') {
        player.baseCrit += (player.level - 1) * 0.01;
    }

    player.artifacts.forEach(art => {
        if(art.effect === 'stat_hp' || art.effect === 'dragon_heart') newMaxHp = Math.floor(newMaxHp * (1 + art.val));
        if(art.effect === 'stat_mp' || art.effect === 'ancient_book') newMaxMp = Math.floor(newMaxMp * (1 + art.val));
        
        if(art.effect === 'stat_atk') newAtk = Math.floor(newAtk * (1 + art.val));
        if(art.effect === 'dragon_heart') newAtk = Math.floor(newAtk * (1 + 0.2)); 
        if(art.effect === 'blood_pact') newAtk = Math.floor(newAtk * 1.2);
        
        if(art.effect === 'stat_matk') newMatk = Math.floor(newMatk * (1 + art.val));
        if(art.effect === 'ancient_book') newMatk = Math.floor(newMatk * (1 + 0.2)); 
        if(art.effect === 'blood_pact') newMatk = Math.floor(newMatk * 1.2);
        
        if(art.effect === 'stat_def') newDef = Math.floor(newDef * (1 + art.val));
        if(art.effect === 'stat_mdef') newMdef = Math.floor(newMdef * (1 + art.val));
        
        if(art.effect === 'stat_crit') player.baseCrit += art.val;
        if(art.effect === 'stat_eva') player.baseEva += art.val;

        // ì‹ ê·œ ìœ ë¬¼ íš¨ê³¼ ì²˜ë¦¬
        if(art.effect === 'stat_def_mdef') {
            newDef = Math.floor(newDef * (1 + art.val));
            newMdef = Math.floor(newMdef * (1 + art.val));
        }
        if(art.effect === 'crit_critdmg') {
            player.baseCrit += 0.1;
            player.baseCritDmg += 0.3;
        }
        if(art.effect === 'matk_mp') {
            newMatk = Math.floor(newMatk * (1 + art.val));
            newMaxMp = Math.floor(newMaxMp * (1 + art.val));
        }
        if(art.effect === 'atk_matk') {
            newAtk = Math.floor(newAtk * (1 + art.val));
            newMatk = Math.floor(newMatk * (1 + art.val));
        }
        if(art.effect === 'atk_hp') {
            newAtk = Math.floor(newAtk * (1 + art.val));
            newMaxHp = Math.floor(newMaxHp * (1 + art.val));
        }
        
        if(art.effect === 'golden_sun') {
             newAtk = Math.floor(newAtk * (1 + art.val)); // 1.25
             newMatk = Math.floor(newMatk * (1 + art.val)); // 1.25
             newMdef = Math.floor(newMdef * 0.8); 
        }
        if(art.effect === 'golden_sun_legend') {
             newAtk = Math.floor(newAtk * 1.4);
             newMatk = Math.floor(newMatk * 1.4);
             newMdef = Math.floor(newMdef * 0.7);
        }

        if(art.effect === 'beelzebub') {
             newAtk = Math.floor(newAtk * 1.5);
             newDef = Math.floor(newDef * 0.7); 
             player.baseCritDmg += 0.5;
        }
        if(art.effect === 'beelzebub_legend') {
             newAtk = Math.floor(newAtk * 1.6);
             newDef = Math.floor(newDef * 0.7);
             player.baseCritDmg += 0.6;
        }

        if(art.effect === 'iris') {
             newMatk = Math.floor(newMatk * 1.5);
             newMdef = Math.floor(newMdef * 1.5);
        }
        if(art.effect === 'iris_legend') {
             newMatk = Math.floor(newMatk * 1.6);
             newMdef = Math.floor(newMdef * 1.6);
        }

        if(art.effect === 'all_stat') {
             newMaxHp = Math.floor(newMaxHp * 1.2);
             newMaxMp = Math.floor(newMaxMp * 1.2);
             newAtk = Math.floor(newAtk * 1.2);
             newMatk = Math.floor(newMatk * 1.2);
             newDef = Math.floor(newDef * 1.2);
             newMdef = Math.floor(newMdef * 1.2);
        }
        if(art.effect === 'royal_crown_legend') {
             newMaxHp = Math.floor(newMaxHp * 1.3);
             newMaxMp = Math.floor(newMaxMp * 1.3);
             newAtk = Math.floor(newAtk * 1.3);
             newMatk = Math.floor(newMatk * 1.3);
             newDef = Math.floor(newDef * 1.3);
             newMdef = Math.floor(newMdef * 1.3);
        }

        if(art.effect === 'blood_pact') newMaxHp = Math.floor(newMaxHp * 0.8);
        if(art.effect === 'reckless') {
            newDef = Math.floor(newDef * 0.7);
            newMdef = Math.floor(newMdef * 0.7);
            player.baseCritDmg += art.val; 
        }
    });

    // ë¡œì—´ë¸”ë£¸ ê³µê²©ë ¥ ì¦ê°€ (ìƒíƒœì°½ í‘œì‹œìš©)
    if(buffs && buffs.player && buffs.player.royalBloomTurns > 0) {
        newAtk = Math.floor(newAtk * 1.5);
        newMatk = Math.floor(newMatk * 1.5);
    }

    // ëŒ€í˜„ì í˜•íƒœ ë³€í™˜ ë° ë²„í”„ ìŠ¤íƒ¯ ì ìš©
    if(player.charKey === 'rumi' && buffs && buffs.player) {
        // í˜•íƒœë³„ ê¸°ë³¸ ìŠ¤íƒ¯ ë³€ê²½
        if(buffs.player.sageForm === 'star') {
            newDef = Math.floor(newDef * 1.5);
            newMdef = Math.floor(newMdef * 1.5);
        } else if(buffs.player.sageForm === 'moon') {
            newMatk = Math.floor(newMatk * 1.5);
            newAtk = Math.floor(newAtk * 0.5);
        } else if(buffs.player.sageForm === 'sun') {
            newAtk = Math.floor(newAtk * 2.0); // ë¬¼ê³µ 100% ì¦ê°€
            newDef = Math.floor(newDef * 0.5);
            newMdef = Math.floor(newMdef * 0.5);
        }

        // ë°€í¬ì‰ì´í¬ ë²„í”„ (í˜•íƒœì™€ ê³±ì—°ì‚° ì ìš©)
        if(buffs.player.milkshakeTurns > 0) {
             newDef = Math.floor(newDef * 1.3);
             newMdef = Math.floor(newMdef * 1.3);
        }
    }

    player.maxHp = newMaxHp;
    player.maxMp = newMaxMp;
    player.atk = newAtk;
    player.matk = newMatk;
    player.def = newDef;
    player.mdef = newMdef;
    
    player.hp = Math.min(player.hp, player.maxHp);
    player.mp = Math.min(player.mp, player.maxMp);
}

function updateInfo() {
    if(!player || !player.name) return;
    document.getElementById('char-name').innerText = player.name;
    document.getElementById('char-lvl').innerText = `Lv.${player.level}`;
    document.getElementById('ui-gold').innerText = gameState.gold;
    document.getElementById('ui-atk').innerText = player.atk;
    document.getElementById('ui-def').innerText = player.def;
    document.getElementById('ui-matk').innerText = player.matk;
    document.getElementById('ui-mdef').innerText = player.mdef;

    let hpPer = player.maxHp ? (player.hp / player.maxHp) * 100 : 0;
    let mpPer = player.maxMp ? (player.mp / player.maxMp) * 100 : 0;
    document.getElementById('hp-bar').style.width = `${Math.max(0, hpPer)}%`;
    document.getElementById('mp-bar').style.width = `${Math.max(0, mpPer)}%`;
    document.getElementById('hp-text').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
    document.getElementById('mp-text').innerText = `${Math.floor(player.mp)}/${player.maxMp}`;

    document.getElementById('vis-p-name').innerText = player.name;
    document.getElementById('vis-p-hp').style.width = `${Math.max(0, hpPer)}%`;
    const pImgBox = document.getElementById('player-img');
    const emojis = { 'luna':'ğŸŒ™', 'zeke':'ğŸ›¡ï¸', 'jasmine':'â˜€ï¸', 'queen':'ğŸŒ¹', 'rumi':'âœ¨' };
    pImgBox.innerHTML = `<img src="${player.charKey}.png" onerror="this.style.display='none'; this.parentNode.innerText='${emojis[player.charKey]}'">`;

    const artBox = document.getElementById('artifact-list');
    if(player.artifacts.length > 0) {
        let artNames = player.artifacts.map(a => 
            `<span onclick="myAlert('[${a.name}]\\n${a.desc}')" style="cursor:pointer; text-decoration:underline; margin-right:5px; color:${a.name.includes('ì—í”½') ? '#e040fb' : '#ffd700'}">${a.name}</span>`
        ).join(" ");
        artBox.innerHTML = `ìœ ë¬¼(í„°ì¹˜): ${artNames}`;
    } else {
        artBox.innerText = "ìœ ë¬¼: ì—†ìŒ";
    }

    const extraUI = document.getElementById('extra-ui');
    if(player.charKey === 'queen') {
        extraUI.style.display = 'block';
        extraUI.style.color = '#f06292';
        extraUI.innerText = `ğŸŒ¹ ì¥ë¯¸ ìŠ¤íƒ: ${roseStack} (ìµœëŒ€ 15)`;
    } else if(player.charKey === 'zeke') {
        extraUI.style.display = 'block';
        extraUI.style.color = '#fff59d';
        let stack = buffs.player.divineStack || 0;
        let enchantText = buffs.player.enchantTurns > 0 ? ` | ğŸ”¥ ì¸ì±ˆíŠ¸: ${buffs.player.enchantTurns}í„´` : "";
        extraUI.innerText = `ğŸ›¡ï¸ ë””ë°”ì¸ ìŠ¤íƒ: ${stack}${enchantText}`;
    } else if(player.charKey === 'rumi') {
        extraUI.style.display = 'block';
        extraUI.style.color = '#81d4fa';
        let formName = "ì—†ìŒ";
        if(buffs.player && buffs.player.sageForm === 'star') formName = "â­ ë³„";
        if(buffs.player && buffs.player.sageForm === 'moon') formName = "ğŸŒ™ ë‹¬";
        if(buffs.player && buffs.player.sageForm === 'sun') formName = "â˜€ï¸ íƒœì–‘";
        let milkshakeText = buffs.player.milkshakeTurns > 0 ? ` | ğŸ¥¤ì‰ì´í¬: ${buffs.player.milkshakeTurns}í„´` : "";
        extraUI.innerText = `ğŸ’ ê¿ˆì˜ ê²°ì •: ${player.dreamCrystals} | í˜•íƒœ: ${formName}${milkshakeText}`;
    } else if(player.charKey === 'luna') {
        extraUI.style.display = 'block';
        extraUI.style.color = '#b39ddb';
        let darkStack = buffs.enemy && buffs.enemy.darkness ? buffs.enemy.darkness : 0;
        extraUI.innerText = `ğŸ’€ ì•”í‘ ìŠ¤íƒ: ${darkStack} (ìµœëŒ€ 5)`;
    } else {
        extraUI.style.display = 'none';
    }
}

function openShop() {
    if(!player || !player.name) return myAlert("ìºë¦­í„° ì„ íƒ í•„ìš”");
    document.getElementById('shop-modal').classList.add('active');
    document.getElementById('shop-gold').innerText = gameState.gold;

    const manaCosts = [1000, 2000, 3000, 4000];
    let costText = gameState.manaLevel >= 4 ? "MAX" : `${manaCosts[gameState.manaLevel]} G`;
    document.getElementById('mana-cost').innerText = costText;

    const nextW = gameState.equipWeapon;
    const nextA = gameState.equipArmor;

    let wText = "MAX";
    if(nextW < 7) {
        let stats = EQUIP_STATS[player.charKey].weapon[nextW];
        wText = `${EQUIP_COSTS[nextW]} G (ATK+${stats.atk}/MATK+${stats.matk})`;
    }
    document.getElementById('weapon-cost').innerText = wText;

    let aText = "MAX";
    if(nextA < 7) {
        let stats = EQUIP_STATS[player.charKey].armor[nextA];
        aText = `${EQUIP_COSTS[nextA]} G (DEF+${stats.def}/MDEF+${stats.mdef})`;
    }
    document.getElementById('armor-cost').innerText = aText;

    const list = document.getElementById('skill-shop-list');
    list.innerHTML = "";

    for(let key in player.skills) {
        if (key === 'basic') continue;
        const sk = player.skills[key];
        const learned = gameState.learnedSkills.includes(key);
        const btn = document.createElement('button');

        btn.innerHTML = `<span style="color:${learned ? '#4caf50':'#fff'}">${sk.name}</span>
                         <span style="font-size:0.7rem; display:block;">${sk.desc}</span>
                         <span style="font-size:0.7rem; color:#ffd700;">${learned ? 'ìŠµë“ì™„ë£Œ' : sk.price + ' G'}</span>`;

        if(!learned) {
            btn.onclick = () => buySkill(key, sk.price);
        } else {
            btn.disabled = true;
            btn.style.opacity = 0.7;
        }
        list.appendChild(btn);
    }
}

function closeShop() {
    document.getElementById('shop-modal').classList.remove('active');
    updateInfo();
}

function upgradeMana() {
    if(gameState.manaLevel >= 4) return;
    const costs = [1000, 2000, 3000, 4000];
    const cost = costs[gameState.manaLevel];
    if(gameState.gold >= cost) {
        gameState.gold -= cost;
        gameState.manaLevel++;
        const regenMap = { 'ë£¨ë‚˜':[10,13,16,20], 'ì§€í¬':[10,13,16,20], 'ììŠ¤ë¯¼':[15,20,25,30], 'ì—¬ì™•':[12,14,16,20], 'ë£¨ë¯¸':[10,15,20,25] };
        const arr = regenMap[player.name];
        player.mpRegen = arr[gameState.manaLevel-1] || arr[arr.length-1];
        openShop();
    }
}

function buyEquip(type) {
    if(!player) return;
    let currentTier = type === 'weapon' ? gameState.equipWeapon : gameState.equipArmor;
    if(currentTier >= 7) return;
    let cost = EQUIP_COSTS[currentTier];
    if(gameState.gold >= cost) {
        gameState.gold -= cost;
        if(type === 'weapon') gameState.equipWeapon++;
        else gameState.equipArmor++;
        recalcAllStats(); 
        openShop();
    }
}

function buySkill(key, price) {
    if(gameState.learnedSkills.includes(key)) return;
    if(gameState.gold >= price) {
        gameState.gold -= price;
        gameState.learnedSkills.push(key);
        openShop();
    } else {
        myAlert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }
}

function healFull() {
    if(gameState.gold >= 50) {
        gameState.gold -= 50;
        player.hp = player.maxHp;
        player.mp = player.maxMp;
        openShop();
    }
}

function resetAllArtifacts() {
    if(player.artifacts.length === 0) return myAlert("ì´ˆê¸°í™”í•  ìœ ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
    let cost = 20000;
    if(gameState.gold < cost) return myAlert(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${cost} G)`);

    if(confirm(`[ì£¼ì˜] ë³´ìœ í•œ ëª¨ë“  ìœ ë¬¼ì„ íŒŒê´´í•˜ê³  ë‹¤ì‹œ ë½‘ìŠµë‹ˆë‹¤.\në¹„ìš©: ${cost} G\n\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        gameState.gold -= cost;
        let count = player.artifacts.length;
        player.artifacts = []; 
        for(let i=0; i<count; i++) rollArtifact(true); 
        recalcAllStats();
        updateInfo();
        myAlert(`ì‹œê°„ì„ ë˜ëŒë ¸ìŠµë‹ˆë‹¤!\nìƒˆë¡œìš´ ìœ ë¬¼ ${count}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`);
    }
}

function rollArtifact(silent=false) {
    let available = ARTIFACTS.filter(a => !hasArtifact(a.id));
    if(available.length === 0) return;

    let pick = available[Math.floor(Math.random() * available.length)];

    player.artifacts.push(pick);
    if(!silent) {
        if(pick.name.includes('ì—í”½')) {
            log(`<b style="color:#e040fb; font-size:1.1rem;">[ëŒ€ë°•!] ì—í”½ ìœ ë¬¼ ë°œê²¬! [${pick.name}]</b>`, 'rose');
            myAlert(`ì¶•í•˜í•©ë‹ˆë‹¤!\nì „ì„¤ì ì¸ ìœ ë¬¼ [${pick.name}]ì„(ë¥¼) ì†ì— ë„£ì—ˆìŠµë‹ˆë‹¤!`);
        } else {
            log(`<span style="color:#ffd700">ìœ ë¬¼ íšë“! [${pick.name}]: ${pick.desc}</span>`, 'info');
        }
    }
    recalcAllStats();
}

function checkLevelUp() {
    let baseReq = 100 * player.level * (1 + player.level * 0.1);
    let nextExp = player.level >= 20 ? baseReq * 3 : baseReq;

    if(player.exp >= nextExp && player.level < 25) { 
        player.level++;
        player.exp = 0;
        recalcAllStats(); 
        log(`ë ˆë²¨ ì—…! Lv.${player.level}`, 'heal');
        if([5, 10, 15, 20, 25].includes(player.level)) {
            rollArtifact();
        }
    }
}

function enterDungeon(tier) {
    const candidates = ENEMIES.filter(e => e.tier === tier);
    if(candidates.length === 0) return myAlert("ëª¬ìŠ¤í„° ë°ì´í„° ì˜¤ë¥˜");
    startBattle(candidates[Math.floor(Math.random() * candidates.length)]);
}

function enterEvent() {
    const candidates = ENEMIES.filter(e => e.tier === 4);
    if(candidates.length === 0) return myAlert("ì´ë²¤íŠ¸ ë³´ìŠ¤ ì˜¤ë¥˜");
    startBattle(candidates[Math.floor(Math.random() * candidates.length)]);
}

function updateBattleUI() {
    updateInfo(); 
    if (currentEnemy) {
        let hpPer = (currentEnemy.hp / currentEnemy.maxHp) * 100;
        document.getElementById('vis-e-hp').style.width = `${Math.max(0, hpPer)}%`;
    }
}

function startBattle(mobData) {
    if(!player || !player.name) return myAlert("ìºë¦­í„° ì„ íƒ í•„ìš”");
    
    document.getElementById('town-menu').style.display = 'none';
    document.getElementById('battle-menu').style.display = 'flex';
    
    const stage = document.getElementById('main-stage');
    stage.classList.remove('town-mode');
    stage.classList.add('battle-mode'); 

    currentEnemy = JSON.parse(JSON.stringify(mobData));
    currentEnemy.maxHp = currentEnemy.hp || 1;

    document.getElementById('vis-e-name').innerText = currentEnemy.name;
    const eImgBox = document.getElementById('enemy-img');
    
    let imgSrc = currentEnemy.img ? currentEnemy.img : `${currentEnemy.name}.png`;
    eImgBox.innerHTML = `<img src="${imgSrc}" onerror="this.style.display='none'; this.parentNode.innerText='ğŸ’€'">`;

    document.getElementById('log-box').innerHTML = "";

    let startMp = player.maxMp ? Math.floor(player.maxMp / 2) : 0;
    if(hasArtifact('start_mp')) startMp += 30;
    
    player.mp = Math.min(player.maxMp, startMp);
    turnCount = 1;
    // ë£¨ë¯¸ ì‹ ê·œ ìŠ¤í‚¬ ê´€ë ¨ ë²„í”„ ì´ˆê¸°í™” ì¶”ê°€ (chargingMilkyway, milkshakeTurns)
    buffs = { player: { castleStack: 0, dodgeCount: 0, absoluteStack: 0, divineStack: 0, moonUltStack: 0, chargingMilkyway: false, milkshakeTurns: 0 }, enemy: {} };
    roseStack = 0; 
    
    if(player.charKey === 'rumi') {
        player.dreamCrystals = 5;
        // ì „íˆ¬ ì‹œì‘ì‹œ í˜•íƒœ ì´ˆê¸°í™”
        delete buffs.player.sageForm;
    }

    if(player.charKey === 'queen') {
        if(hasArtifact('royal_crown')) {
            roseStack = 5;
            log("ë¡œì—´ í¬ë¼ìš´ì˜ íš¨ê³¼ë¡œ ì¥ë¯¸ 5ì†¡ì´ë¥¼ ê°€ì§€ê³  ì‹œì‘í•©ë‹ˆë‹¤!", 'rose');
        }
        if(hasArtifact('royal_crown_legend')) {
            roseStack = 10;
            log("ì „ì„¤ì˜ ë¡œì—´ í¬ë¼ìš´ íš¨ê³¼ë¡œ ì¥ë¯¸ 10ì†¡ì´ë¥¼ ê°€ì§€ê³  ì‹œì‘í•©ë‹ˆë‹¤!", 'rose');
        }
    }

    // ëŒ€í˜„ì ìŠ¤íƒ¯ ì¬ê³„ì‚° (í˜•íƒœ ì´ˆê¸°í™” ë°˜ì˜)
    recalcAllStats();

    updateBattleUI();
    createBattleButtons();
    log(`<b>${currentEnemy.name}</b>(ì´)ê°€ ë‚˜íƒ€ë‚¬ë‹¤!`, 'info');
}

function createBattleButtons() {
    const box = document.getElementById('action-btns');
    box.innerHTML = "";
    gameState.learnedSkills = gameState.learnedSkills || ['basic'];
    gameState.learnedSkills.forEach(key => {
        const sk = player.skills[key];
        if(!sk) return;
        const btn = document.createElement('button');
        let cls = 'btn-skill';
        if(sk.type === 'phy' || sk.type === 'mag') cls = 'btn-atk';
        if(sk.type === 'sup') cls = 'btn-def';
        if(sk.type === 'ult') cls = 'btn-ult';
        btn.className = cls;
        btn.innerHTML = `${sk.name}<span class="skill-sub">MP ${sk.cost}</span>`;
        btn.onclick = () => executeTurn(key);
        box.appendChild(btn);
    });
}
function executeTurn(skillKey) {
    if(!player || !currentEnemy) return;

    if(buffs.player.stun) {
        log("í–‰ë™ ë¶ˆê°€ ìƒíƒœì…ë‹ˆë‹¤!", 'dmg');
        if(!enemyTurn()) return loseBattle();
        endTurnPhase();
        return;
    }

    const skill = player.skills[skillKey];
    
    // ëŒ€í˜„ì í˜•íƒœ ë³€í™˜ ë¹„ìš© ë° ê²°ì • ì²´í¬
    if(skill.effect.startsWith('form_change_')) {
        if(skill.effect !== 'form_change_sun' && player.dreamCrystals < 1) { 
             if(player.dreamCrystals < 1) { log("ê¿ˆì˜ ê²°ì •ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'info'); return; }
        }
        if(skill.effect === 'form_change_sun' && player.dreamCrystals < 1) { log("ê¿ˆì˜ ê²°ì •ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'info'); return; }
        
        // ë¹„ìš© ì†Œëª¨
        if(skill.effect !== 'form_change_sun') player.dreamCrystals--; 
        if(skill.effect === 'form_change_sun') player.dreamCrystals--; 
    }

    // ì°¨ì§• ìŠ¤í‚¬ ì²˜ë¦¬
    if(skill.effect === 'charge_divine' || skill.effect === 'charge_milkyway') {
        let chargingFlag = skill.effect === 'charge_divine' ? 'charging' : 'chargingMilkyway';
        let chargeMsg = skill.effect === 'charge_divine' ? "í˜ì„ ëª¨ìœ¼ë©° ë°©ì–´ íƒœì„¸ë¥¼ ì·¨í•©ë‹ˆë‹¤." : "ë³„ë“¤ì˜ í˜ì„ ëª¨ìœ¼ê¸° ì‹œì‘í•©ë‹ˆë‹¤. (ì°¨ì§€/ë°©ì–´íƒœì„¸)";
        let chargeColor = skill.effect === 'charge_divine' ? 'holy' : 'star';

        if(!buffs.player[chargingFlag]) {
            if(player.mp < skill.cost) { log("ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'info'); return; }
            player.mp -= skill.cost;
            buffs.player[chargingFlag] = true;
            buffs.player.guard = true; 
            log(`${skill.name}! ${chargeMsg}`, chargeColor);
            if(!enemyTurn()) return loseBattle();
            endTurnPhase();
            return;
        } else {
            delete buffs.player[chargingFlag];
            delete buffs.player.guard;
        }
    } else {
        if(player.mp < skill.cost) { log("ë§ˆë‚˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'info'); return; }
        player.mp -= skill.cost;
    }

    log(`<div class="log-turn">=== Turn ${turnCount} ===</div>`);

    let playerDefending = false;
    
    if(skill.effect === 'milkshake_heal') {
        let healAmount = Math.floor(player.maxHp * 0.3);
        player.hp = Math.min(player.maxHp, player.hp + healAmount);
        log(`ìŠ¤íƒ€íŒŒìš°ë” ë°€í¬ì‰ì´í¬! HP <span class="heal">${healAmount}</span> íšŒë³µ.`, 'heal');
    }

    // [FIX] ì„œí¬íŠ¸ ìŠ¤í‚¬ ì ìš© ì¡°ê±´ì— 'sage_moon_veil'ê³¼ 'sage_meteor' ì¶”ê°€
    if(skill.type === 'sup' || skill.effect === 'perfect_eva' || skill.effect === 'guard_70' || skill.effect === 'null_mag' || skill.effect === 'null_phy' || 
       skill.effect === 'evasion_50' || skill.effect === 'eva_buff' || skill.effect === 'crit_buff' || skill.effect === 'passive_boost' || 
       skill.effect.startsWith('form_change_') || skill.effect === 'sage_barrier' || skill.effect === 'milkshake_heal' ||
       skill.effect === 'sage_moon_veil' || skill.effect === 'sage_meteor' || skill.effect === 'royal_bloom') { // <-- ì˜ˆì™¸ ì¶”ê°€ë¨
        
        applyPlayerSupport(skill);
        
        if(skill.effect === 'stun_rose_3') {
             if(roseStack >= 3) {
                 roseStack -= 3;
                 buffs.enemy.stun = true;
                 log("ì¥ë¯¸ 3ê°œë¥¼ ì†Œëª¨í•˜ì—¬ ì ì„ ì••ë„í•©ë‹ˆë‹¤!", 'rose');
             } else {
                 log("ì¥ë¯¸ ìŠ¤íƒì´ ë¶€ì¡±í•˜ì—¬ ë°œë™ ì‹¤íŒ¨!", 'info');
             }
        }
        playerDefending = true;
    }

    if(buffs.enemy.counter && turnCount > buffs.enemy.counterTurn + 1) delete buffs.enemy.counter;

    let enemyAlive = true;
    
    // [FIX] ê³µê²© ìŠ¤í‚¬ ì¡°ê±´ì— 'sage_moon_veil'ê³¼ 'sage_meteor' ì˜ˆì™¸ ì¶”ê°€ (playerDefendingì´ trueì—¬ë„ ê³µê²© ì‹¤í–‰)
    if(!playerDefending || skill.effect === 'perfect_eva' || skill.effect === 'rose_2_self_stun' || 
       skill.effect === 'evasion_50' || skill.effect === 'eva_buff' || skill.effect === 'crit_buff' ||
       skill.effect === 'form_change_sun' || skill.effect === 'sage_dream_ult' ||
       skill.effect === 'sage_moon_veil' || skill.effect === 'sage_meteor') { // <-- ì˜ˆì™¸ ì¶”ê°€ë¨
        
        if(skill.effect === 'sage_dream_ult' || !skill.effect.startsWith('form_change_')) {
            document.getElementById('player-actor').classList.add('shake');
            setTimeout(()=> document.getElementById('player-actor').classList.remove('shake'), 250);
            enemyAlive = playerAttack(skill);
        }
    }

    let playerAlive = true;
    if(enemyAlive) {
        if(buffs.enemy.stun) {
            log(`${currentEnemy.name}ì€(ëŠ”) ê¸°ì ˆí•˜ì—¬ ì›€ì§ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`, 'info');
            delete buffs.enemy.stun;
        } else {
            document.getElementById('enemy-actor').classList.add('shake');
            setTimeout(()=> document.getElementById('enemy-actor').classList.remove('shake'), 250);
            
            playerAlive = enemyTurn();
        }
    }
    
    if(playerAlive && enemyAlive) endTurnPhase();
    else if(!enemyAlive) winBattle();
    else loseBattle();
}

function applyPlayerSupport(skill) {
    if(skill.effect === 'guard_70') buffs.player.guard_70 = true;
    if(skill.effect === 'null_mag') buffs.player.nullMag = true;
    if(skill.effect === 'null_phy') buffs.player.nullPhy = true;
    
    if(skill.effect === 'sage_barrier') {
        buffs.player.sageBarrier = true;
        let form = buffs.player.sageForm;
        log(`ìŠ¤íƒ€ ë°°ë¦¬ì–´! í”¼í•´ ${form==='star'?70:50}% ê°ì†Œ.`, 'star');
    }

    if(skill.effect.startsWith('form_change_')) {
        let type = skill.effect.split('_')[2]; 
        buffs.player.sageForm = type;
        buffs.player.formTurns = 3;
        recalcAllStats(); 
        let names = {'star':'ë³„', 'moon':'ë‹¬', 'sun':'íƒœì–‘'};
        log(`[${names[type]}ì˜ í˜•íƒœ]ë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤!`, 'star');
    }

    if(skill.effect === 'milkshake_heal') {
        if(buffs.player.sageForm === 'star') {
            buffs.player.milkshakeTurns = 10;
            log("ë³„ì˜ í˜•íƒœ ì¶”ê°€ íš¨ê³¼! 10í„´ê°„ ë°©ì–´ë ¥/ë§ˆë²•ë°©ì–´ë ¥ì´ 30% ì¦ê°€í•©ë‹ˆë‹¤.", 'star');
            recalcAllStats(); 
        }
    }

    if(skill.effect === 'evasion_50') {
        buffs.player.eva = (buffs.player.eva || 0) + 0.5;
        log("ì œë…¸ì‚¬ì´ë“œ ìŠ¤íƒ­! ì”ìƒìœ¼ë¡œ íšŒí”¼ìœ¨ì´ ê¸‰ì¦í•©ë‹ˆë‹¤.", 'info');
    }
    if(skill.effect === 'next_eva') buffs.player.nextEva = 0.5;

    if(skill.effect === 'perfect_eva') buffs.player.eva = (buffs.player.eva || 0) + 10.0; 
    
    if(skill.effect === 'eva_buff') {
        let val = skill.name === 'ë² ì¼ ì˜¤ë¸Œ ë‹¤í¬ë‹ˆìŠ¤' ? 0.4 : 0.2;
        buffs.player.veilVal = val;
        buffs.player.veilTurns = 3;
        buffs.player.eva = (buffs.player.eva || 0) + val; 
        log("íšŒí”¼ìœ¨ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.", 'info');
    }

    // [FIX] ë¬¸ë¼ì´íŠ¸ ë² ì¼
    if(skill.effect === 'sage_moon_veil') {
        if(buffs.player.sageForm === 'moon') {
             buffs.player.veilVal = 0.4;
             buffs.player.veilTurns = 3;
             buffs.player.eva = (buffs.player.eva || 0) + 0.4;
             log("ë‹¬ë¹›ì˜ ê°€í˜¸ë¡œ íšŒí”¼ìœ¨ì´ ëŒ€í­ ì¦ê°€í•©ë‹ˆë‹¤!", 'star');
        } else {
             log("ë¬¸ë¼ì´íŠ¸ ë² ì¼ ë°œë™ (ë‹¬ì˜ í˜•íƒœê°€ ì•„ë‹ˆì–´ì„œ ì¶”ê°€íš¨ê³¼ ì—†ìŒ).", 'info');
        }
    }
    
    // [FIX] ë©”í…Œì˜¤ ìŠ¤ë§¤ì‹œ
    if(skill.effect === 'sage_meteor') {
        if(buffs.player.sageForm === 'sun') {
            buffs.player.critBuff = true;
            buffs.player.critBuffTurns = 3;
            log("íƒœì–‘ì˜ í˜ìœ¼ë¡œ ì¹˜ëª…íƒ€ìœ¨ì´ ê¸‰ì¦í•©ë‹ˆë‹¤!", 'star');
        }
    }

    if(skill.effect === 'crit_buff') {
        buffs.player.critBuff = true;
        buffs.player.critBuffTurns = 3;
        log("ì¹˜ëª…íƒ€ìœ¨ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤!", 'rose');
    }
    
    if(skill.effect === 'instinct') {
        buffs.player.instinctTurns = 5;
        buffs.player.instinctVal = 0.25;
        buffs.player.eva = (buffs.player.eva || 0) + 0.25; 
        log("ë³¸ëŠ¥ ë°œë™! íšŒí”¼ì™€ í”¼í•´ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤.", 'info');
    }

    if(skill.effect === 'adrenaline') {
        buffs.player.adrenalineTurns = 4;
        log("ì•„ë“œë ˆë‚ ë¦° í­ë°œ! ì¹˜ëª…íƒ€ í”¼í•´ê°€ ì¦ê°€í•©ë‹ˆë‹¤.", 'rose');
    }
    if(skill.effect === 'immortal') {
        buffs.player.immortal = true;
        log("ì´ë²ˆ í„´ ì£½ì§€ ì•ŠìŠµë‹ˆë‹¤.", 'fire');
    }
    if(skill.effect === 'divine_buff') {
        buffs.player.divineTurns = 4;
        log("ë””ë°”ì¸ ì•„ë¨¸ ì „ê°œ!", 'holy');
    }
    if(skill.effect === 'enchant_buff') {
        buffs.player.enchantTurns = 5;
        log("ë¬´ê¸°ì— í™”ì—¼ì„ ë‘˜ë €ìŠµë‹ˆë‹¤!", 'fire');
    }
    if(skill.effect === 'reflect') {
        buffs.player.sanctuaryTurns = 3;
        log("ë§ˆë²• ë°˜ì‚¬ ë³´í˜¸ë§‰ ìƒì„±!", 'holy');
    }
    if(skill.effect === 'medi') {
        buffs.player.medi = true;
        buffs.player.mediTurns = 4;
        log("ëª…ìƒ ì‹œì‘. ë§ˆë‚˜ íšŒë³µ ì¦ê°€.", 'heal');
    }
    if(skill.effect === 'dmg_red_50') buffs.player.dmgRed50 = true;
    if(skill.effect === 'passive_boost') {
        buffs.player.gardenTurns = 3;
        log("ì—¬ì™•ì˜ ì •ì›ì´ í¼ì³ì§‘ë‹ˆë‹¤. íŒ¨ì‹œë¸Œ íš¨ê³¼ 2ë°°!", 'rose');
    }
    if(skill.effect === 'add_rose_3') {
        roseStack = Math.min(15, roseStack + 3);
        log("ì¥ë¯¸ 3ì†¡ì´ê°€ í”¼ì–´ë‚¬ìŠµë‹ˆë‹¤.", 'rose');
    }

    if(skill.effect === 'royal_bloom') {
        buffs.player.royalBloomTurns = 3;
        // roseStack = 0; // ì¦‰ì‹œ ì†Œë©¸í•˜ì§€ ì•ŠìŒ
        log("Royal Bloom! ì¥ë¯¸ê°€ ë§Œê°œí•˜ì—¬ í˜ì„ ê°œë°©í•©ë‹ˆë‹¤! (3í„´ê°„ ê³µ/ë§ˆê³µ 50% ì¦ê°€, ì¢…ë£Œ ì‹œ ì‹œë“¦)", 'rose');
    }
}

function winBattle() {
    log(`<b style="color:#ffd700">ì „íˆ¬ ìŠ¹ë¦¬!</b>`, 'info');
    player.exp += currentEnemy.exp;
    gameState.gold += currentEnemy.gold;
    log(`ê²½í—˜ì¹˜ +${currentEnemy.exp}, ê³¨ë“œ +${currentEnemy.gold} G`);
    
    if(currentEnemy.name === "ì°½ì¡°ì‹  ì•„ìŠ¤í…Œì•„") {
        saveClear(player.charKey);
        alert("ì¶•í•˜í•©ë‹ˆë‹¤! ì°½ì¡°ì‹ ì„ ë¬¼ë¦¬ì¹˜ê³  ì „ì„¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n~ THE END ~");
    }

    checkLevelUp();
    
    setTimeout(() => {
        document.getElementById('battle-menu').style.display = 'none';
        document.getElementById('town-menu').style.display = 'grid'; 
        
        const stage = document.getElementById('main-stage');
        stage.classList.remove('battle-mode');
        stage.classList.add('town-mode'); 

        updateInfo();
    }, 1500);
}

function loseBattle() {
    log(`<b style="color:#ff5252">ì „íˆ¬ íŒ¨ë°°...</b>`, 'dmg');
    player.hp = 1;
    setTimeout(() => {
        document.getElementById('battle-menu').style.display = 'none';
        document.getElementById('town-menu').style.display = 'grid'; 
        
        const stage = document.getElementById('main-stage');
        stage.classList.remove('battle-mode');
        stage.classList.add('town-mode');

        updateInfo();
    }, 1500);
}

function hasArtifact(key) {
    return player.artifacts && player.artifacts.some(a => a.id === key || a.effect === key);
}

function playerAttack(skill) {
    if(currentEnemy.name === "ë§ˆì‹ ") {
        if(turnCount % 2 !== 0 && skill.type === 'phy') { log("ë§ˆì‹ ì€ í™€ìˆ˜ í„´ì— ë¬¼ë¦¬ ê³µê²©ì— ë©´ì—­ì…ë‹ˆë‹¤!", 'info'); return true; }
        if(turnCount % 2 === 0 && skill.type === 'mag') { log("ë§ˆì‹ ì€ ì§ìˆ˜ í„´ì— ë§ˆë²• ê³µê²©ì— ë©´ì—­ì…ë‹ˆë‹¤!", 'info'); return true; }
    }

    if(buffs.enemy.counter && skill.type === 'phy') {
        let counterDmg = Math.floor(currentEnemy.atk * 2.0);
        player.hp -= counterDmg;
        log(`${currentEnemy.name}ì˜ ì¹´ìš´í„°! <span class="dmg">${counterDmg}</span>ì˜ í”¼í•´ë¥¼ ì…ê³  ë°˜ê²©ë‹¹í–ˆìŠµë‹ˆë‹¤!`, 'dmg');
        return true; 
    }

    if(skill.effect === 'miss_chance' && Math.random() < 0.3) { log(`${skill.name}ì´(ê°€) ë¹—ë‚˜ê°”ìŠµë‹ˆë‹¤!`, 'info'); return true; }

    let multiplier = skill.power;
    
    if(skill.name === 'ë” í™€ë¦¬' && buffs.player.goddessTurns) {
        multiplier += 3.5; 
        log("ì—¬ì‹  ê°•ë¦¼ì˜ í˜ìœ¼ë¡œ ìœ„ë ¥ì´ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤!", 'holy');
    }

    if(skill.effect === 'stack_dmg') {
        multiplier += (buffs.player.absoluteStack || 0);
        buffs.player.absoluteStack = Math.min(5.0, (buffs.player.absoluteStack || 0) + 1.0);
    }
    
    if(skill.effect === 'rose_finisher') {
        multiplier += (roseStack * 0.4);
        multiplier = Math.min(11.0, multiplier); 
        roseStack = 0;
        log("í”¼ë‚ ë ˆ! ëª¨ë“  ì¥ë¯¸ê°€ í­ë°œí•©ë‹ˆë‹¤!", 'rose');
    }

    if(skill.effect === 'hp_reverse') {
        let lostRatio = (player.maxHp - player.hp) / player.maxHp;
        multiplier = 3.0 + (lostRatio * 6.0);
    }
    if(skill.effect === 'hp_reverse_mid') {
        let lostRatio = (player.maxHp - player.hp) / player.maxHp;
        multiplier = 1.2 + (lostRatio * 2.2);
    }
    
    if(skill.effect === 'stack_ult_new') {
        buffs.player.castleStack = Math.min(5, (buffs.player.castleStack || 0) + 1);
        multiplier = buffs.player.castleStack * 1.8;
        buffs.player.castleDef100 = true; 
    }
    if(skill.effect === 'charge_divine') {
        let stack = buffs.player.divineStack || 0;
        multiplier += (stack * 0.3);
        buffs.player.divineStack = 0;
        log(`ë””ë°”ì¸ ë¸”ë ˆì´ë“œ! ${stack}ìŠ¤íƒ í­ë°œ!`, 'holy');
    }

    if(skill.effect === 'sage_silent' && buffs.player.sageForm === 'moon') multiplier += 0.4;
    if(skill.effect === 'sage_god_hand' && buffs.player.sageForm === 'sun') multiplier += 0.4;

    if(skill.effect === 'sage_dream_ult') {
        multiplier = 4.0; 
        let activeForm = buffs.player.sageForm;
        
        if(activeForm) {
            delete buffs.player.sageForm;
            delete buffs.player.formTurns;
            recalcAllStats(); 
        }

        if(activeForm === 'star') {
            buffs.enemy.stun = true;
            log("[ë³„ì˜ ê¿ˆ] ì ì„ ê¸°ì ˆì‹œí‚µë‹ˆë‹¤!", 'star');
        } else if(activeForm === 'moon') {
            buffs.player.moonUltStack = (buffs.player.moonUltStack || 0) + 1;
            let bonus = buffs.player.moonUltStack * 3.5;
            multiplier = bonus;
            log(`[ë‹¬ì˜ ê¿ˆ] ëˆ„ì ëœ ì¹´ìš´íŠ¸(${buffs.player.moonUltStack})ë¡œ ìœ„ë ¥ í­ë°œ! (+${bonus.toFixed(1)}ë°°)`, 'star');
        } else if(activeForm === 'sun') {
            let crystals = player.dreamCrystals || 0;
            let bonus = crystals * 1.5;
            multiplier += bonus;
            log(`[íƒœì–‘ì˜ ê¿ˆ] ë‚¨ì€ ê²°ì •(${crystals})ë§Œí¼ ìœ„ë ¥ ì¦ê°€! (+${bonus.toFixed(1)}ë°°)`, 'star');
        } else {
            multiplier = 2.5;
            log("í˜•íƒœ ì—†ì´ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ìœ„ë ¥ìœ¼ë¡œ ë°œë™í•©ë‹ˆë‹¤.", 'info');
        }
    }

    let isPhy = skill.type === 'phy' || skill.name === 'ë¼ê·¸ë‚˜ë¡œí¬' || skill.name === 'ì´í´ë¦½ìŠ¤';
    let atkVal = isPhy ? player.atk : player.matk;
    
    if(skill.effect === 'sage_hybrid_mana' || skill.effect === 'charge_milkyway') {
        atkVal = (player.atk + player.matk); 
        if(skill.effect === 'sage_hybrid_mana') atkVal /= 2; 

        if(skill.effect === 'charge_milkyway') {
            log("ì€í•˜ìˆ˜ì˜ í˜ì´ ê°œë°©ë©ë‹ˆë‹¤!", 'star');
        }
    }

    if(hasArtifact('high_risk_dmg')) multiplier *= 1.3;
    if(hasArtifact('high_risk_dmg_ex')) multiplier *= 2.0;
    
    if(buffs.player.medi && !isPhy) atkVal *= 0.5;

    if(buffs.player.goddessTurns) atkVal *= 2.0;
    
    if(buffs.player.goddessBlessing) atkVal *= 1.5;
    // if(buffs.player.royalBloomTurns) atkVal *= 1.5; // recalcAllStatsë¡œ ì´ë™ë¨

    if(buffs.player.undyingPowerTurns) {
        atkVal *= 2.0;
        log("ì£½ìŒì„ ê·¹ë³µí•œ í˜ìœ¼ë¡œ ê³µê²©ë ¥ì´ 2ë°°ê°€ ë©ë‹ˆë‹¤!", 'fire');
    }

    let critChance = player.baseCrit;
    if(buffs.player.critBuff) {
    critChance += (player.charKey === 'rumi') ? 0.40 : 0.25;}
    if(skill.effect === 'guarantee_crit') critChance = 1.0;
    if(skill.name === 'ì–´ìŒ”ì‹  ë„¤ì¼') critChance += (buffs.enemy.darkness || 0) * 0.3;
    
    // [FIX] ë©”í…Œì˜¤ ìŠ¤ë§¤ì‹œ ë²„í”„ ë¡œì§ ì œê±° (applyPlayerSupportë¡œ ì´ë™ë¨)
    // if(skill.effect === 'sage_meteor' && buffs.player.sageForm === 'sun') { ... }

    let isCrit = Math.random() < critChance;
    if(isCrit) {
        let critDmg = player.baseCritDmg;
        if(buffs.player.adrenalineTurns) critDmg += 1.0;
        if(hasArtifact('reckless')) critDmg += 0.5;
        atkVal *= critDmg;
    }

    if(player.name === 'ì§€í¬') {
        if(player.hp < player.maxHp * 0.25) atkVal *= 1.3;
        else if(player.hp < player.maxHp * 0.5) atkVal *= 1.15;
    }

    let defVal = isPhy ? currentEnemy.def : currentEnemy.mdef;
    
    if(skill.type === 'phy' && buffs.enemy.darkness) {
        let reduction = 0.10 * buffs.enemy.darkness; 
        defVal *= (1 - reduction);
    }

    if(isPhy && buffs.enemy.defDownTurns > 0) defVal *= 0.8;
    if(!isPhy && buffs.enemy.mdefDownTurns > 0) defVal *= 0.8;

    let dmg = atkVal * multiplier * (100 / (100 + defVal));
    dmg = Math.floor(dmg);
    dmg = Math.max(1, dmg); 

    if(skill.effect === 'hp_cost') player.hp -= player.maxHp * 0.1;
    if(skill.effect === 'hp_cost_20') player.hp -= player.maxHp * 0.2;
    if(skill.effect === 'reset_buff') { 
        player.hp = player.maxHp; 
        buffs.player.goddessTurns = 3;
        log("ì—¬ì‹  ê°•ë¦¼! ìƒíƒœ ë¦¬ì…‹ ë° ëŠ¥ë ¥ì¹˜ 2ë°°!", 'heal'); 
    }
    
    if(skill.effect === 'darkness') {
        let add = 0;
        if(skill.name === 'í¬ë¡œìŠ¤ ì»·' && isCrit) add = 3; 
        else if(skill.name === 'ì„€ë„ìš° ë³¼') add = 1; 
        
        if(add > 0) {
            buffs.enemy.darkness = Math.min(5, (buffs.enemy.darkness || 0) + add);
            log(`ì•”í‘ ìŠ¤íƒì´ ${add} ìŒ“ì˜€ìŠµë‹ˆë‹¤! (í˜„ì¬: ${buffs.enemy.darkness})`, 'info');
        }
    }
    
    if(skill.effect === 'sage_hybrid_mana' && isCrit) {
        player.mp = Math.min(player.maxMp, player.mp + 40);
        log("íŠ¸ìœ™í´ ì¹˜ëª…íƒ€! ë§ˆë‚˜ 40 íšŒë³µ.", 'heal');
    }

    if(skill.effect === 'self_stun' || skill.effect === 'rose_2_self_stun') {
        buffs.player.nextTurnStun = true;
        log("ë¬´ë¦¬í•œ í–‰ë™ìœ¼ë¡œ ë‹¤ìŒ í„´ì— ì›€ì§ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", 'info');
    }

    if(skill.effect === 'self_def_zero') buffs.player.defZeroNext = true;

    if(skill.effect === 'def_down') buffs.enemy.defDownTurns = 3;
    if(skill.effect === 'mdef_down') buffs.enemy.mdefDownTurns = 3;
    if(skill.effect === 'burn') buffs.enemy.burnTurns = 3;
    
    if(skill.effect === 'add_rose_1') roseStack = Math.min(15, roseStack + 1);
    if(skill.effect === 'rose_2_self_stun') roseStack = Math.min(15, roseStack + 2);
    if(skill.effect === 'crit_rose_6' && isCrit) { roseStack = Math.min(15, roseStack + 6); log("ì¹˜ëª…íƒ€! ì¥ë¯¸ê°€ ê¸‰ê²©íˆ í”¼ì–´ë‚©ë‹ˆë‹¤!", 'rose'); }

    let enchantDmg = 0;
    if(buffs.player.enchantTurns > 0 && (isPhy || (skill.type === 'ult' && player.name === 'ì§€í¬'))) {
        let eMult = 0.7;
        if(skill.effect === 'fire_combo_new') eMult = 1.4;
        enchantDmg = Math.floor(player.matk * eMult * (100 / (100 + currentEnemy.mdef)));
        enchantDmg = Math.max(1, enchantDmg); 
    }

    currentEnemy.hp -= dmg;
    let critMsg = isCrit ? " <b>(ì¹˜ëª…íƒ€!)</b>" : "";
    log(`${skill.name}! ì ì—ê²Œ <span class="dmg">${dmg}${critMsg}</span> í”¼í•´.`);

    if(enchantDmg > 0) {
        currentEnemy.hp -= enchantDmg;
        log(`íŒŒì´ì–´ ì¸ì±ˆíŠ¸ ì¶”ê°€íƒ€! <span class="fire">${enchantDmg}</span> ë§ˆë²• í”¼í•´.`, 'fire');
    }
    
    if(hasArtifact('vampire')) {
        let heal = Math.floor((dmg + enchantDmg) * 0.05);
        player.hp = Math.min(player.maxHp, player.hp + heal);
    }

    if(skill.effect === 'multi_hit' && buffs.player.dodgeCount) {
        let hits = Math.min(4, buffs.player.dodgeCount);
        let extraDmg = dmg * hits;
        extraDmg = Math.max(1, extraDmg); 
        currentEnemy.hp -= extraDmg;
        log(`ëŒ„ì‹± ëŒ€ê±° ì¶”ê°€ ${hits}íƒ€! <span class="dmg">${extraDmg}</span> í”¼í•´.`);
    }

    if(currentEnemy.hp <= 0 && currentEnemy.ai === 'witch' && !currentEnemy.hasRevived) {
        currentEnemy.hp = 3000;
        currentEnemy.hasRevived = true;
        log(`<b style="color:#29b6f6">í˜¹í•œì˜ ë§ˆë…€ê°€ ì–¼ìŒ ì†ì—ì„œ ë˜ì‚´ì•„ë‚©ë‹ˆë‹¤! (HP 3000 íšŒë³µ)</b>`, 'info');
        return true; 
    }

    return currentEnemy.hp > 0;
}

function enemyTurn() {
    if(currentEnemy.name === "ì„¸ê³„ìˆ˜") {
        currentEnemy.atk += 5;
        currentEnemy.matk += 5;
    }

    if(buffs.enemy.burnTurns > 0) {
        let burnDmg = Math.floor(player.matk * 0.5);
        burnDmg = Math.max(1, burnDmg);
        currentEnemy.hp -= burnDmg;
        log(`í™”ìƒ í”¼í•´! <span class="dmg">${burnDmg}</span>`, 'info');
        buffs.enemy.burnTurns--;
        if(currentEnemy.hp <= 0) return false;
    }

    if(currentEnemy.ai === 'charge') {
        if(buffs.enemy.charging) {
            delete buffs.enemy.charging;
            log(`${currentEnemy.name}ì˜ ì°¨ì§€ ì–´íƒ ë°œì‚¬!`, 'dmg');
            return applyEnemyDamage(currentEnemy.atk * 2.5, 'phy');
        }
        if(Math.random() < 0.3) {
            log(`${currentEnemy.name}ì´(ê°€) ê¸°ë¥¼ ëª¨ìœ¼ê¸° ì‹œì‘í•©ë‹ˆë‹¤...`, 'info');
            buffs.enemy.charging = true;
            return true;
        }
    }

    if(currentEnemy.ai === 'witch') {
        let isEnraged = (currentEnemy.hp < currentEnemy.maxHp * 0.25);
        let multiplier = 1.0;
        if(isEnraged) {
            multiplier = 2.0;
            log(`<b style="color:#29b6f6">ë§ˆë…€ê°€ ìƒëª…ì˜ ìœ„í˜‘ì„ ëŠë¼ê³  í­ì£¼í•©ë‹ˆë‹¤! (ê³µê²©ë ¥ 2ë°°)</b>`, 'dmg');
        }

        let rand = Math.random();
        if(rand < 0.1) {
            log(`<b style="color:#4fc3f7">ì ˆëŒ€ì˜ë„! (ëª¨ë“  ê²ƒì„ ì–¼ë ¤ë²„ë¦½ë‹ˆë‹¤!)</b>`, 'mag');
            return applyEnemyDamage(currentEnemy.matk * 5.0 * multiplier, 'mag');
        } else if(rand < 0.4) {
            log(`ì•„ì´ìŠ¤ ë¹”!`, 'mag');
            return applyEnemyDamage(currentEnemy.matk * 2.0 * multiplier, 'mag');
        } else {
            log(`ë§ˆë…€ì˜ ëƒ‰ê¸° ê³µê²©`, 'phy');
            return applyEnemyDamage(currentEnemy.atk * multiplier, 'phy');
        }
    }

    if(currentEnemy.ai === 'goddess') {
        if(turnCount <= 2) {
            if(turnCount === 1) {
                log(`<b style="color:#ff5252">[ì‹¬íŒì˜ í˜•íƒœ] ì—¬ì‹ ì´ ê±°ëŒ€í•œ í˜ì„ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤...</b>`, 'info');
                return true; 
            }
            if(turnCount === 2) {
                log(`<b style="color:#ff5252; font-size:1.1rem;">ì €ì§€ë¨¼íŠ¸!!</b>`, 'dmg');
                return applyEnemyDamage(currentEnemy.matk * 3.5, 'mag');
            }
        }
        
        if(currentEnemy.hp <= currentEnemy.maxHp * 0.5) {
            if(buffs.player.goddessBlessing) {
                delete buffs.player.goddessBlessing;
                log(`<b style="color:#e040fb">[ê²€ì˜ í˜•íƒœ] "ìì• ëŠ” ëë‚¬ë‹¤."</b>`, 'dmg');
                log(`í”Œë ˆì´ì–´ì˜ ì¶•ë³µì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'info');
            }

            if(buffs.enemy.charging) {
                delete buffs.enemy.charging;
                log(`<b style="color:#ff5252">ë””ë°”ì¸ ë¸”ë ˆì´ë“œ! (ì°¨ì§€ ë°œë™)</b>`, 'dmg');
                return applyEnemyDamage(currentEnemy.atk * 4.5, 'phy');
            }

            let rand = Math.random();
            if(rand < 0.2) {
                log(`ì—¬ì‹ ì´ ê²€ì„ ë†’ì´ ë“­ë‹ˆë‹¤... (ì°¨ì§€)`, 'info');
                buffs.enemy.charging = true;
                return true;
            } else if(rand < 0.4) {
                log(`í™€ë¦¬ ë ˆì´!`, 'mag');
                return applyEnemyDamage(currentEnemy.matk * 2.0, 'mag');
            } else {
                log(`ì—¬ì‹ ì˜ ê²€ê²©!`, 'dmg');
                return applyEnemyDamage(currentEnemy.atk * 1.0, 'phy');
            }
        }
        
        if(!buffs.player.goddessBlessing) {
            buffs.player.goddessBlessing = true;
            log(`<b style="color:#69f0ae">[ìì• ì˜ í˜•íƒœ] "ë„ˆì˜ í˜ì„ ë³´ì—¬ë³´ì•„ë¼."</b>`, 'heal');
            log(`í”Œë ˆì´ì–´ ê³µê²©ë ¥/ë§ˆë²•ê³µê²©ë ¥ 50% ì¦ê°€!`, 'heal');
        }

        if(turnCount >= 7) {
            log(`<b style="color:#ffd700">ë” í™€ë¦¬! (ê´‘ì—­ ì‹¬íŒ)</b>`, 'holy');
            player.hp -= 550;
            log(`<span class="dmg">550</span>ì˜ ì ˆëŒ€ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤!`, 'dmg');
            return player.hp > 0;
        }

        log(`ì—¬ì‹ ì˜ ìì• ë¡œìš´ í‰íƒ€`, 'info');
        return applyEnemyDamage(currentEnemy.atk * 1.0, 'phy');
    }

    if(currentEnemy.ai === 'tree' && turnCount === 4) {
        log(`ì„¸ê³„ìˆ˜ì˜ ë¹›! ëª¨ë‘ ì™„ì „ íšŒë³µ.`, 'heal');
        player.hp = player.maxHp;
        currentEnemy.hp = currentEnemy.maxHp;
        updateBattleUI();
        return true;
    }
    if(currentEnemy.ai === 'ghost_king' && turnCount % 5 === 0) {
        log(`ê³ ìŠ¤íŠ¸ í‚¹ ë°˜ê²© íƒœì„¸!`, 'info');
        buffs.enemy.counter = true;
        buffs.enemy.counterTurn = turnCount;
        return true;
    }
    if((currentEnemy.ai === 'mawang' && turnCount % 5 === 0) || (currentEnemy.ai === 'mashin' && turnCount % 7 === 0)) {
        log(`${currentEnemy.name}ì˜ ë°ìŠ¤ í•¸ë“œ!`, 'dmg');
        return applyEnemyDamage(currentEnemy.atk * 3.5, 'phy');
    }

    if(Math.random() < 0.3 && currentEnemy.ai !== 'charge') {
        let val = currentEnemy.skillType === 'phy' ? currentEnemy.atk : currentEnemy.matk;
        log(`${currentEnemy.name}ì˜ ${currentEnemy.skillName}!`, 'dmg');
        return applyEnemyDamage(val * currentEnemy.skillPower, currentEnemy.skillType);
    } else {
        log(`${currentEnemy.name}ì˜ ê³µê²©!`, 'dmg');
        return applyEnemyDamage(currentEnemy.atk, 'phy');
    }
}

function applyEnemyDamage(rawDmg, type) {
    let eva = player.baseEva + (buffs.player.eva || 0);
    if(Math.random() < eva) {
        log("ì ì˜ ê³µê²©ì„ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!", 'info');
        if(player.skills['dancing']) buffs.player.dodgeCount = (buffs.player.dodgeCount || 0) + 1;
        return true;
    }

    let def = type === 'mag' ? player.mdef : player.def;
    
    if(buffs.player.defZero) def = 0;
    else {
        let defMult = 1.0;
        if(buffs.player.divineTurns) defMult += 0.3; 
        if(buffs.player.castleDef100) defMult += 1.0; 
        
        if(player.name === 'ì§€í¬') {
            if(player.hp < player.maxHp * 0.25) defMult += 0.3;
            else if(player.hp < player.maxHp * 0.5) defMult += 0.15;
        }
        
        def *= defMult;
    }

    if(buffs.player.goddessTurns) def *= 2.0;

    let dmg = rawDmg * (100 / (100 + def));

    if(hasArtifact('high_risk_dmg')) dmg *= 1.2;
    if(hasArtifact('high_risk_dmg_ex')) dmg *= 1.5;

    if(buffs.player.nullMag && type === 'mag') dmg = 0;
    if(buffs.player.nullPhy && type === 'phy') dmg = 0;
    if(buffs.player.guard_70) dmg *= 0.3;
    if(buffs.player.guard) dmg *= 0.3;
    if(buffs.player.dmgRed50) dmg *= 0.5;
    if(buffs.player.instinctTurns) dmg *= 1.2;
    
    if(buffs.player.sageBarrier) {
        let reduction = buffs.player.sageForm === 'star' ? 0.3 : 0.5; 
        dmg *= reduction;
    }

    dmg = Math.floor(dmg);
    dmg = Math.max(1, dmg); 
    
    if(buffs.player.divineTurns > 0 && dmg > 0) {
        buffs.player.divineStack = (buffs.player.divineStack || 0) + 1;
    }

    if(buffs.player.immortal && player.hp - dmg <= 0) {
        player.hp = 1;
        log(`ì–¸ë‹¤ì‰ ë°œë™! ì£½ìŒì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤!`, 'fire');
        if(player.name === 'ì§€í¬') {
            buffs.player.undyingPowerTurns = 2; 
        }
    } else {
        if(player.hp - dmg <= 0 && !buffs.player.revived) {
             if(hasArtifact('guardian_angel')) {
                buffs.player.revived = true;
                player.hp = Math.floor(player.maxHp * 0.5);
                log("<b>ìˆ˜í˜¸ì²œì‚¬ì˜ ê¹ƒí„¸ì´ ë¶€ì„œì§€ë©° ë¶€í™œí–ˆìŠµë‹ˆë‹¤! (HP 50% íšŒë³µ)</b>", 'heal');
             } else if(hasArtifact('guardian_angel_legend')) {
                buffs.player.revived = true;
                player.hp = player.maxHp;
                log("<b>[ì „ì„¤] ìˆ˜í˜¸ì²œì‚¬ì˜ ê¹ƒí„¸ì´ ë¹›ë‚˜ë©° ì™„ì „í•˜ê²Œ ë¶€í™œí–ˆìŠµë‹ˆë‹¤! (HP 100% íšŒë³µ)</b>", 'heal');
             } else {
                player.hp -= dmg;
                log(`<span class="dmg">${dmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'dmg');
             }
        } else {
            player.hp -= dmg;
            log(`<span class="dmg">${dmg}</span> í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`, 'dmg');
        }
    }

    if(buffs.player.sanctuaryTurns > 0) {
        let refDmg = Math.floor(player.matk * 1.5 * (100 / (100 + currentEnemy.mdef)));
        refDmg = Math.max(1, refDmg);
        currentEnemy.hp -= refDmg;
        log(`ìƒì¸„ì–´ë¦¬ ë°˜ì‚¬! ì ì—ê²Œ ${refDmg} í”¼í•´.`, 'dmg');
    }

    if(hasArtifact('reflect_phy') && type === 'phy') {
        let thornDmg = Math.floor(dmg * 0.1);
        if(thornDmg > 0) {
            currentEnemy.hp -= thornDmg;
            log(`ìœ ë¬¼ ë°˜ì‚¬! ${thornDmg} í”¼í•´.`, 'dmg');
        }
    }

    return player.hp > 0;
}

function endTurnPhase() {
    if(player.charKey === 'queen' && roseStack > 0 && currentEnemy.hp > 0) {
        let roseDmg = Math.floor((player.atk + player.matk) * 0.1 * roseStack);
        let defVal = currentEnemy.def;
        let reduction = 100 / (100 + defVal);
        roseDmg = Math.floor(roseDmg * reduction);
        if(buffs.player.gardenTurns) roseDmg *= 2;
        roseDmg = Math.max(1, roseDmg);
        
        currentEnemy.hp -= roseDmg;
        log(`[íŒ¨ì‹œë¸Œ] ì¥ë¯¸ì˜ ê°€ì‹œê°€ ì ì„ ì°Œë¦…ë‹ˆë‹¤! <span class="rose">${roseDmg}</span> í”¼í•´`, 'rose');
        if(currentEnemy.hp <= 0) { winBattle(); return; }
    }
    
    if(hasArtifact('regen_10')) {
        let regen = Math.floor(player.maxHp * 0.1);
        player.hp = Math.min(player.maxHp, player.hp + regen);
    }

    delete buffs.player.guard; 
    delete buffs.player.guard_70; 
    delete buffs.player.nullMag;
    delete buffs.player.nullPhy;
    delete buffs.player.castleDef100; 
    delete buffs.player.stun; 
    delete buffs.player.immortal;
    delete buffs.player.dmgRed50;
    delete buffs.player.sageBarrier; 
    
    if(buffs.player.defZero) delete buffs.player.defZero;
    if(buffs.player.defZeroNext) { buffs.player.defZero = true; delete buffs.player.defZeroNext; }

    if(buffs.player.nextTurnStun) {
        buffs.player.stun = true;
        delete buffs.player.nextTurnStun;
    }

    if(buffs.player.instinctTurns) { buffs.player.instinctTurns--; if(buffs.player.instinctTurns<=0) { delete buffs.player.instinctVal; } }
    if(buffs.player.adrenalineTurns) { buffs.player.adrenalineTurns--; if(buffs.player.adrenalineTurns<=0) { delete buffs.player.critUp; } }
    if(buffs.player.veilTurns) { buffs.player.veilTurns--; if(buffs.player.veilTurns<=0) { delete buffs.player.veilVal; } }
    if(buffs.player.mediTurns) { buffs.player.mediTurns--; if(buffs.player.mediTurns<=0) { delete buffs.player.medi; } }
    if(buffs.player.divineTurns) buffs.player.divineTurns--;
    if(buffs.player.vulcanTurns) buffs.player.vulcanTurns--;
    if(buffs.player.sanctuaryTurns) buffs.player.sanctuaryTurns--;
    if(buffs.player.goddessTurns) buffs.player.goddessTurns--;
    
    // ëŒ€í˜„ì í˜•íƒœ ë° ë²„í”„ í„´ ê°ì†Œ
    if(buffs.player.formTurns) {
        buffs.player.formTurns--;
        if(buffs.player.formTurns <= 0) {
            delete buffs.player.sageForm;
            delete buffs.player.formTurns;
            log("í˜•íƒœ ë³€í™˜ì˜ í˜ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.", 'info');
        }
    }
    if(buffs.player.milkshakeTurns) {
        buffs.player.milkshakeTurns--;
        if(buffs.player.milkshakeTurns <= 0) log("ë°€í¬ì‰ì´í¬ ë²„í”„ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.", 'info');
    }
    // í„´ ì¢…ë£Œì‹œ ìŠ¤íƒ¯ ì¬ê³„ì‚° (í˜•íƒœ/ë²„í”„ ë§Œë£Œ ë°˜ì˜)
    recalcAllStats();

    if(buffs.player.critBuffTurns) { buffs.player.critBuffTurns--; if(buffs.player.critBuffTurns<=0) delete buffs.player.critBuff; }
    if(buffs.player.gardenTurns) buffs.player.gardenTurns--;
    if(buffs.player.royalBloomTurns) {
        buffs.player.royalBloomTurns--;
        if(buffs.player.royalBloomTurns <= 0) {
            roseStack = 0;
            log("Royal Bloom íš¨ê³¼ê°€ ëë‚˜ë©° ì¥ë¯¸ê°€ ì‹œë“¤ì—ˆìŠµë‹ˆë‹¤...", 'rose');
        }
    }

    if(buffs.player.enchantTurns) buffs.player.enchantTurns--;
    if(buffs.player.undyingPowerTurns) { buffs.player.undyingPowerTurns--; if(buffs.player.undyingPowerTurns<=0) log("ì–¸ë‹¤ì‰ í˜ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.", 'info'); }

    if(buffs.enemy.defDownTurns) buffs.enemy.defDownTurns--;
    if(buffs.enemy.mdefDownTurns) buffs.enemy.mdefDownTurns--;

    let totalEva = 0;
    if(buffs.player.instinctTurns > 0) totalEva += (buffs.player.instinctVal || 0);
    if(buffs.player.veilTurns > 0) totalEva += (buffs.player.veilVal || 0);
    buffs.player.eva = totalEva;

    if(buffs.player.nextEva) { buffs.player.eva += buffs.player.nextEva; delete buffs.player.nextEva; }

    let regen = player.mpRegen;
    if(buffs.player.medi) regen += 30;
    if(hasArtifact('mana_engine')) regen += 10;
    
    player.mp = Math.min(player.maxMp, player.mp + regen);
    
    updateBattleUI();
    turnCount++;
}
</script>
</body>
</html>
